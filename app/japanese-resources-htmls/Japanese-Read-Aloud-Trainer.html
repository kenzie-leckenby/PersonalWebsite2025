<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Japanese Read-Aloud Trainer (Phrase / Sentence Toggle)</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
         max-width: 900px; margin: 24px auto; padding: 12px; line-height: 1.5; }
  h1 { font-size: 1.4rem; margin-bottom: 6px; }
  textarea { width: 100%; height: 140px; font-size: 1.05rem; padding: 8px; box-sizing: border-box; }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; align-items: center; }
  label { font-size: 0.9rem; }
  select, input[type=range] { margin-left: 6px; }
  button { padding: 8px 12px; font-size: 0.95rem; }
  .mora { margin-top: 10px; font-size: 0.95rem;
          background: #f4f4f8; padding: 10px; border-radius: 6px; }
  .chunk { display: inline-block; margin: 2px; padding: 4px 6px;
           border-radius: 4px; background: #fff; box-shadow: 0 0 0 1px #e6e6ea;
           cursor: pointer; transition: background 0.25s; user-select: none; }
  .chunk:hover { background: #eef2ff; }
  .chunk.clicked { background: #ffe9b5; transition: background 0.4s ease; }
  .note { margin-top: 8px; color: #444; font-size: 0.9rem; }
  .warning { margin-top:12px; color:#9a2b2b; background:#fff6f6;
             padding:8px; border:1px solid #f0c6c6; border-radius:6px; }
</style>
</head>
<body>
<h1>Japanese Read-Aloud Trainer</h1>
<p>
Type Japanese text and press <strong>Speak</strong>.  
Click a chunk to repeat it — or switch to <em>Full Sentence Mode</em> for sentence-level playback.
</p>

<textarea id="text" placeholder="例: Copy and pasate or type your text here; from https://news.yahoo.co.jp/ for xeample 40代からの新しい挑戦が実りました。やっと次のスタートラインに立てました。" autofocus>
</textarea>

<div class="controls">
  <label>Voice: <select id="voiceSelect"></select></label>
  <label>Rate <input id="rate" type="range" min="0.5" max="2.0" step="0.05" value="1">
    <span id="rateVal">1.00</span></label>
  <label>Pitch <input id="pitch" type="range" min="0.5" max="2.0" step="0.05" value="1">
    <span id="pitchVal">1.00</span></label>
  <label>Volume <input id="volume" type="range" min="0" max="1" step="0.05" value="1">
    <span id="volumeVal">1.00</span></label>
  <label><input id="loop" type="checkbox"> Loop</label>
  <label><input id="sentenceMode" type="checkbox"> Full sentence mode</label>
  <button id="speak">Speak</button>
  <button id="cancel">Stop</button>
</div>

<div class="mora">
  <strong>Visualization / count</strong>
  <div id="moraChunks" style="margin-top:8px;"></div>
  <div style="margin-top:6px;">Total chunks: <span id="moraCount">0</span></div>
  <div class="note">Kanji compounds + okurigana stay together (e.g., 実りました).</div>
</div>

<div id="voiceWarningContainer"></div>

<script>
/* --- UI elements --- */
const textEl = document.getElementById('text');
const voiceSelect = document.getElementById('voiceSelect');
const rateEl = document.getElementById('rate');
const pitchEl = document.getElementById('pitch');
const volumeEl = document.getElementById('volume');
const rateVal = document.getElementById('rateVal');
const pitchVal = document.getElementById('pitchVal');
const volumeVal = document.getElementById('volumeVal');
const loopEl = document.getElementById('loop');
const sentenceModeEl = document.getElementById('sentenceMode');
const speakBtn = document.getElementById('speak');
const cancelBtn = document.getElementById('cancel');
const moraChunks = document.getElementById('moraChunks');
const moraCount = document.getElementById('moraCount');
const voiceWarningContainer = document.getElementById('voiceWarningContainer');

rateEl.oninput = ()=> rateVal.textContent = Number(rateEl.value).toFixed(2);
pitchEl.oninput = ()=> pitchVal.textContent = Number(pitchEl.value).toFixed(2);
volumeEl.oninput = ()=> volumeVal.textContent = Number(volumeEl.value).toFixed(2);

/* --- Load voices --- */
let voices = [];
function loadVoices() {
  voices = speechSynthesis.getVoices().sort((a,b)=> a.name.localeCompare(b.name));
  voiceSelect.innerHTML = '';
  const preferred = voices.filter(v => v.lang?.startsWith('ja'));
  const others = voices.filter(v => !v.lang?.startsWith('ja'));
  const addOpt = v => {
    const o = document.createElement('option');
    o.value = v.name; o.textContent = `${v.name} — ${v.lang}`;
    voiceSelect.appendChild(o);
  };
  if (preferred.length) {
    preferred.forEach(addOpt);
    if (others.length) {
      const sep = document.createElement('option');
      sep.textContent = '────────── Other voices ──────────';
      sep.disabled = true;
      voiceSelect.appendChild(sep);
      others.forEach(addOpt);
    }
    voiceSelect.value = preferred[0].name;
  } 
}
loadVoices();
speechSynthesis.onvoiceschanged = loadVoices;

/* --- Speak --- */
function speak(textOverride) {
  const text = (textOverride || textEl.value).trim();
  if (!text) return;
  const utter = new SpeechSynthesisUtterance(text);
  const chosen = voices.find(v => v.name === voiceSelect.value);
  if (chosen) utter.voice = chosen;
  utter.lang = 'ja-JP';
  utter.rate = Number(rateEl.value);
  utter.pitch = Number(pitchEl.value);
  utter.volume = Number(volumeEl.value);
  utter.onend = ()=> {
    if (loopEl.checked && !textOverride) setTimeout(()=> speak(), 250);
  };
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

/* --- Buttons --- */
speakBtn.onclick = ()=> speak();
cancelBtn.onclick = ()=> speechSynthesis.cancel();

/* --- Phrase Chunking --- */
const reKanji = /[\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF]/;
const reHiragana = /[ぁ-ん]/;
const reKana = /[ぁ-んァ-ンー]/;
function splitJapaneseChunks(text) {
  const chars = Array.from(text);
  const chunks = [];
  let current = '', mode = null;
  for (let i=0;i<chars.length;i++) {
    const ch = chars[i];
    if (/\s/.test(ch)) { if (current) chunks.push(current); current=''; mode=null; continue; }
    const isKanji = reKanji.test(ch);
    const isKana = reKana.test(ch);
    if (isKanji) {
      if (current) chunks.push(current);
      let cluster = ch;
      let j = i+1;
      while (j<chars.length && reKanji.test(chars[j])) cluster += chars[j++];
      while (j<chars.length && reHiragana.test(chars[j])) cluster += chars[j++];
      chunks.push(cluster); i=j-1; continue;
    }
    if (isKana) { if (mode==='kana') current+=ch; else { if (current) chunks.push(current); current=ch; mode='kana'; } continue; }
    if (current) chunks.push(current);
    chunks.push(ch);
    current=''; mode=null;
  }
  if (current) chunks.push(current);
  return chunks.filter(c=>c.trim()!=='');
}

/* --- Full sentence split --- */
function splitSentences(text) {
  // split at 。！？ keeping punctuation at end of sentence
  return text.split(/(?<=[。！？])/g).map(s=>s.trim()).filter(s=>s);
}

/* --- Visualization --- */
function updateVisualization() {
  const text = textEl.value.trim();
  let chunks;
  if (sentenceModeEl.checked) {
    chunks = splitSentences(text);
  } else {
    chunks = splitJapaneseChunks(text);
  }
  moraChunks.innerHTML = '';
  chunks.forEach(c=>{
    const span = document.createElement('span');
    span.className='chunk';
    span.textContent=c;
    span.title='Click to speak';
    span.onclick=()=>{
      span.classList.add('clicked');
      setTimeout(()=>span.classList.remove('clicked'),400);
      speak(c);
    };
    moraChunks.appendChild(span);
  });
  moraCount.textContent = chunks.length;
}

textEl.addEventListener('input', updateVisualization);
textEl.addEventListener('keyup', updateVisualization);
sentenceModeEl.addEventListener('change', updateVisualization);
updateVisualization();
</script>
</body>
</html>
