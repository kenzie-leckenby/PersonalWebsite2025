<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="appTitle">Puyo-style Falling Vocab Game</title>
<style>
:root{
  --bg-dark:#071033;
  --card:#f1fbff;         /* snow panel */
  --accent:#0ea5c9;
  --muted:#4b6471;
  --light-pink: #FFD1DC; /* <--- New variable for Blush Pink */
  --good:#16a34a;
  --bad:#ef4444;
  --btn-bg: rgba(14,165,201,0.12);
  --btn-border: rgba(14,165,201,0.45);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Noto Sans JP", "Hiragino Kaku Gothic Pro", system-ui, -apple-system, Arial; -webkit-font-smoothing:antialiased}
body{background:linear-gradient(180deg,#e6f7ff 0%, #eaf9ff 100%);color:#04202a;display:flex;align-items:flex-start;justify-content:center;padding:18px}
.app{width:1300px;max-width:100%;background:linear-gradient(180deg,#ffffff,#f3fbff);border-radius:12px;padding:14px;box-shadow:0 12px 40px rgba(4,32,42,0.08)}
.header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.header h1{margin:0;font-size:20px;color:#033b49}
.tabs{display:flex;gap:6px}
.tab-btn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.tab-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
.controls{display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap}
.controls .small{font-size:15px;color:var(--muted)}

/* --- Action buttons forced to next line (from previous request) --- */
.control-actions {
  flex-basis: 100%;
  display: flex;
  gap: 6px;
  margin-top: 6px;
  justify-content: flex-end;
}
/* ----------------------------------------------------------- */

/* TIMER STYLES */
.stat.timer-display{
  font-weight:700;
  color:var(--accent);
  font-size:22px;
  padding: 4px 8px;
  border: 1px solid var(--btn-border);
  border-radius: 6px;
}
.stat.timer-display.low{
  color:var(--bad);
  animation: pulseRed 500ms infinite alternate;
}
@keyframes pulseRed{
  from{opacity:1}
  to{opacity:0.75}
}
/* END TIMER STYLES */

.layout{display:flex;gap:16px;flex-direction:column}
.container{display:block}
.top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.stat{font-size:14px;color:var(--muted)}

.card{background:var(--card);padding:12px;border-radius:10px;min-height:420px;border:1px solid rgba(3,59,73,0.04)}
.game-wrap{display:flex;gap:16px;align-items:flex-start}
.game-area{position:relative;width:100%;height:400px;border-radius:8px;background:linear-gradient(180deg,#dff7ff,#eafcff);overflow:hidden;border:1px solid rgba(3,59,73,0.06);display:flex;align-items:flex-end;justify-content:center;padding-bottom:8px}
.hud{display:flex;gap:14px;align-items:center}
.answer-bar{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
.choice-btn{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(3,59,73,0.06);background:white;cursor:pointer;font-size:20px;color:#063642;font-weight:600;box-shadow:0 6px 18px rgba(6,52,58,0.03)}
.choice-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(6,52,58,0.06)}
.choice-btn.correct{background:var(--good);border:2px solid rgba(16,185,129,0.9);color:white}
.choice-btn.wrong{background:var(--bad);border:2px solid rgba(239,68,68,0.9);color:white}
.choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.preview{width:220px;padding-left:12px}
.preview .pv-title{font-size:15px;color:var(--muted);margin-bottom:8px}
.vocab-list{max-height:420px;overflow:auto}
.vocab-row{padding:8px;border-bottom:1px dashed rgba(3,59,73,0.03);display:flex;justify-content:space-between;align-items:center}
.flash-big-jp{font-size:72px;line-height:1;margin-bottom:6px;color:#033b49}
.flash-reading{font-size:28px;color:var(--muted)}
.flash-eng{font-size:22px;text-align:center;margin-top:10px;color:#04202a}
.small{font-size:12px;color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
.kana-note{font-size:12px;color:var(--muted);margin-top:6px}
.footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
.btn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.btn:hover{background:rgba(14,165,201,0.22);border-color:rgba(14,165,201,0.8);color:white}
@media(max-width:880px){
  .app{padding:10px}
  .game-area{height:520px}
  .preview{display:none}
}
/* pile cell and block styles */
.pile-grid{position:absolute;left:0;right:0;bottom:8px;height:100%;pointer-events:none}
.pile-column{position:absolute;bottom:8px;display:flex;flex-direction:column-reverse;align-items:center;gap:6px}
.block{
  /* 1. CSS VISUAL WIDTH */
  width:120px;
  height:100px;
  /* ----------------------------------------------------------------------------- */
  border-radius:8px;
  background:white;
  border: 2px solid var(--light-pink);
¬† box-shadow: 0 6px 18px rgba(6,52,58,0.04);
  display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:6px;font-weight:700;color:#08323a;
  transform-origin:center;
}
.block.jp{background:linear-gradient(180deg,#ffffff,#ecfeff)}
.block.fail{
	opacity:0.95
	border: 2px solid var(--bad); /* <-- Adds a red border to failed blocks */}
.stack-area{position:absolute;left:0;right:0;bottom:8px;pointer-events:none}
.flash-success{position:absolute;inset:0;background:rgba(16,185,129,0.06);pointer-events:none;animation:fadeOut 420ms forwards}
.flash-fail{position:absolute;inset:0;background:rgba(239,68,68,0.06);pointer-events:none;animation:fadeOut 420ms forwards}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Puyo-style vocab game">
    <div class="header">
      <h1 id="lessonTitle">Piled Falling Vocab Game</h1>
      <div class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="vocab">Vocabulary List</button>
        <button class="tab-btn" data-tab="flash">Flashcards</button>
        <button class="tab-btn" data-tab="game">Game</button>
      </div>

      <div class="controls">
        <!-- Lesson, Mode, and Speed Selectors (Keep on the first line) -->
        <div class="small">Lesson:
            <select id="lessonSelect" class="small" style="margin-left:6px"></select>
        </div>
        <div class="small">Mode: <strong id="modeLabel">Japanese ‚Üí English</strong></div>
        <div class="small">Speed:
          <select id="speedSelect" class="small" style="margin-left:6px">
            <option value="slow">Slow</option>
            <option value="normal" selected>Normal</option>
            <option value="fast">Fast</option>
            <option value="veryfast">Very Fast</option>
          </select>
        </div>
<div style="margin-top:10px;">
  <label for="rateControl">üéßSpeech Rate:</label>
  <input type="range" id="rateControl" min="0.5" max="2" step="0.1" value="1"
         style="vertical-align:middle;">
  <span id="rateValue">1.0√ó</span>
</div>
<div style="margin-top:8px;">
  <label for="voiceSelect">üó£Ô∏èVoice:</label>
  <select id="voiceSelect"></select>
</div>
        <!-- Action Buttons (Wrapped in a new div to force a line break) -->
        <div class="control-actions">
            <button id="startBtn" class="btn">Start</button>
            <button id="pauseBtn" class="btn">Pause</button>
            <button id="resetBtn" class="btn">Reset</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div id="vocab" class="container card" style="display:block">
        <div class="top-row">
          <strong id="vocabListTitle">Vocabulary</strong>
          <div class="small">Click üîä to hear pronunciation</div>
        </div>
        <div class="vocab-list" id="vocabList"></div>
        <div style="margin-top:8px">
          <button id="openFlash" class="btn">Open Flashcards</button>
          <button id="openGame" class="btn">Open Game</button>
        </div>
      </div>

      <div id="flash" class="container card" style="display:none">
        <div class="top-row">
          <strong>Flashcards</strong>
          <div>
            <button id="prevFlash" class="btn">Prev</button>
            <button id="nextFlash" class="btn">Next</button>
            <button id="shuffleFlash" class="btn">Shuffle</button>
            <button id="hearFlash" class="btn">üîä Hear</button>
          </div>
        </div>
        <div class="center" style="flex-direction:column;min-height:360px;justify-content:flex-start">
          <div class="flash-big-jp" id="flashJP">Êº¢Â≠óÔºà„Åã„Å™Ôºâ</div>
          <div class="flash-reading" id="flashReading">(„Åã„Å™)</div>
          <div class="flash-eng" id="flashEN">English meaning</div>
        </div>
      </div>

      <div id="game" class="container" style="display:none">
        <div class="card">
          <div class="top-row">
            <div>
              <strong>Game: <span id="gameLessonTitle"></span></strong>
              <div class="small">Japanese (Kanji + reading) falls ‚Äî choose the correct English meaning</div>
            </div>
            <div class="hud">
              <div class="stat">Score: <span id="score">0</span></div>
              <div class="stat">Lives (pile space): <span id="lives">6</span></div>
              <div class="stat">Streak: <span id="streak">0</span></div>
              <div class="stat timer-display" id="timerDisplay">10s</div>
            </div>
          </div>

          <div class="game-wrap">
            <div style="flex:1;position:relative;">
              <div id="gameArea" class="game-area" aria-live="polite">
                <div id="pileGrid" class="pile-grid"></div>
                <div id="stackArea" class="stack-area"></div>
              </div>

              <div id="answerArea" class="answer-bar" style="margin-top:12px"></div>

              <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
                <div class="small">Next:</div>
                <div id="preview" class="small" style="min-width:240px;color:var(--muted)"></div>
                <div class="small">Pile reaches top ‚Üí Game Over</div>
              </div>
            </div>

            <div class="preview" id="sidePreview" aria-hidden="true">
              <div class="pv-title">Preview</div>
              <div id="pvContent" style="font-size:18px;color:var(--muted)"></div>
              <div style="margin-top:12px">
                <button id="openVocabTab" class="btn">Open Vocab</button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>

    <div class="footer">
      <div class="small">‚û§Editable ‚Äî You can open this HTML in a text editor and edit arrays in the &lt;script&gt;if you want to change or add new words or new set of words.</div>
      <div class="small">‚û§This exercise is designed and created to run locally and in a single-html-file, browser format, by Tseng, Ken-sensei, George Mason University, Japanese Program, and co-coded by ChatGPT and Gemini„ÄÇPlease disregard our typo if any.üôè. P.S. It has not been tested with any smart phone.</div>
    </div>
  </div>

<script>
/* ------------------ All Vocab Lessons ------------------ */
let speechRate = 0.75;
let selectedVoice = null;

document.getElementById("rateControl").addEventListener("input", (e)=>{
  speechRate = parseFloat(e.target.value);
  document.getElementById("rateValue").textContent = speechRate.toFixed(2) + "√ó";
});


const allLessons = {
    'greetings': {
        title: '„ÅÇ„ÅÑ„Åï„Å§',
        data: [
            {j:'„Åä„ÅØ„Çà„ÅÜ', r:'„Åä„ÅØ„Çà„ÅÜ', e:'Morning'},
            {j:'„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô', r:'„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô', e:'Good morning'},
            {j:'‰ªäÊó•„ÅØ', r:'„Åì„Çì„Å´„Å°„ÅØ', e:'Good day/good afternoon'},
            {j:'‰ªäÊô©„ÅØ', r:'„Åì„Çì„Å∞„Çì„ÅØ', e:'Good evening'},
            {j:'„Åï„Çà„ÅÜ„Å™„Çâ', r:'„Åï„Çà„ÅÜ„Å™„Çâ', e:'Good-bye'},
            {j:'„Åä‰ºë„ÅøÔºà„Å™„Åï„ÅÑÔºâ', r:'„Åä„ÇÑ„Åô„ÅøÔºà„Å™„Åï„ÅÑÔºâ', e:'Good night'},
            {j:'„ÅÇ„Çä„Åå„Å®„ÅÜ', r:'„ÅÇ„Çä„Åå„Å®„ÅÜ', e:'Thanks'},
            {j:'„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô', r:'„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô', e:'Thank you very much'},
            {j:'„Åô„Åø„Åæ„Åõ„Çì', r:'„Åô„Åø„Åæ„Åõ„Çì', e:"Excuse me/I'm sorry"}, 
            {j:'„ÅÑ„ÅÑ„Åà', r:'„ÅÑ„ÅÑ„Åà', e:'No;Not at all'},
            {j:'Ë°å„Å£„Å¶„Åç„Åæ„Åô', r:'„ÅÑ„Å£„Å¶„Åç„Åæ„Åô', e:"I'll go and come back"},
            {j:'Ë°å„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑ', r:'„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑ', e:'Please go and come back'},
            {j:'„Åü„Å†‰ªä', r:'„Åü„Å†„ÅÑ„Åæ', e:"I'm home"},
            {j:'„ÅäÂ∏∞„ÇäÔºà„Å™„Åï„ÅÑÔºâ', r:'„Åä„Åã„Åà„ÇäÔºà„Å™„Åï„ÅÑÔºâ', e:'Welcome home'},
            {j:'„ÅÑ„Åü„Å†„Åç„Åæ„Åô', r:'„ÅÑ„Åü„Å†„Åç„Åæ„Åô', e:'Thank you for the food (before eating)'},
            {j:'„ÅîÈ¶≥Ëµ∞„Åï„ÅæÔºà„Åß„Åó„ÅüÔºâ', r:'„Åî„Å°„Åù„ÅÜ„Åï„ÅæÔºà„Åß„Åó„ÅüÔºâ', e:'Thank you for the food (after eating)'},
            {j:'Âàù„ÇÅ„Åæ„Åó„Å¶', r:'„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶', e:'Nice to meet you (starting phrase)'},
            {j:'ÔΩûÔΩû„Åß„Åô', r:'„Å™„Å´„Å™„Å´„Åß„Åô', e:'I am blah blah blah'},
            {j:'ÂÆú„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ', r:'„Çà„Çç„Åó„Åè„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô', e:'Nice to meet you(ending phrase)'},
        ]
    },
    'genkiL1': {
        title: '„É¨„ÉÉ„Çπ„É≥1',
        data: [
  {j:'Â§ßÂ≠¶', r:'„Å†„ÅÑ„Åå„Åè', e:'college; university'},
  {j:'È´òÊ†°', r:'„Åì„ÅÜ„Åì„ÅÜ', e:'high school'},
  {j:'Â≠¶Áîü', r:'„Åå„Åè„Åõ„ÅÑ', e:'student'},
  {j:'Â§ßÂ≠¶Áîü', r:'„Å†„ÅÑ„Åå„Åè„Åõ„ÅÑ', e:'college student'},
  {j:'ÁïôÂ≠¶Áîü', r:'„Çä„ÇÖ„ÅÜ„Åå„Åè„Åõ„ÅÑ', e:'international student'},
  {j:'ÂÖàÁîü', r:'„Åõ„Çì„Åõ„ÅÑ', e:'teacher; professor'},
  {j:'„ÄúÂπ¥Áîü', r:'„Äú„Å≠„Çì„Åõ„ÅÑ', e:'... year student'},
  {j:'‰∏ÄÂπ¥Áîü', r:'„ÅÑ„Å°„Å≠„Çì„Åõ„ÅÑ', e:'first-year student'},
  {j:'Â∞ÇÊîª', r:'„Åõ„Çì„Åì„ÅÜ', e:'major'},
  {j:'ÁßÅ', r:'„Çè„Åü„Åó', e:'I/me'},
  {j:'Âèã„Å†„Å°', r:'„Å®„ÇÇ„Å†„Å°', e:'friend(s)'},
  {j:'„Äú„Åï„Çì', r:'„Äú„Åï„Çì', e:'Mr./Mrs./Ms.'},
  {j:'„Äú‰∫∫', r:'„Äú„Åò„Çì', e:'... people (nationality)'},
  {j:'Êó•Êú¨‰∫∫', r:'„Å´„Åª„Çì„Åò„Çì', e:'Japanese people'},
  {j:'‰ªä', r:'„ÅÑ„Åæ', e:'now'},
  {j:'ÂçàÂâç', r:'„Åî„Åú„Çì', e:'A.M.'},
  {j:'ÂçàÂæå', r:'„Åî„Åî', e:'P.M.'},
  {j:'„ÄúÊôÇ', r:'„Äú„Åò', e:"...o'clock"},
  {j:'‰∏ÄÊôÇ', r:'„ÅÑ„Å°„Åò', e:"one o'clock"},
  {j:'Âçä', r:'„ÅØ„Çì', e:'half'},
  {j:'‰∫åÊôÇÂçä', r:'„Å´„Åò„ÅØ„Çì', e:'half past two'},
  {j:'Êó•Êú¨', r:'„Å´„Åª„Çì', e:'Japan'},
  {j:'„Ç¢„É°„É™„Ç´', r:'„ÅÇ„ÇÅ„Çä„Åã', e:'U.S.A.'},
  {j:'ÔΩû„ÄúË™û', r:'„Äú„Åî', e:'...language'},
  {j:'Êó•Êú¨Ë™û', r:'„Å´„Åª„Çì„Åî', e:'Japanese language'},
  {j:'„ÄúÊ≠≥', r:'„Äú„Åï„ÅÑ', e:'... years old'},
  {j:'ÈõªË©±', r:'„Åß„Çì„Çè', e:'telephone'},
  {j:'„ÄúÁï™', r:'„Äú„Å∞„Çì', e:'number'},
  {j:'Áï™Âè∑', r:'„Å∞„Çì„Åî„ÅÜ', e:'number'},
  {j:'ÂêçÂâç', r:'„Å™„Åæ„Åà', e:'name'},
  {j:'‰Ωï', r:'„Å™„Çì„Éª„Å™„Å´', e:'what'},
		  {j:'„Ç§„ÇÆ„É™„Çπ', r:'„ÅÑ„Åé„Çä„Åô', e:'Britain'},
  {j:'„Ç™„Éº„Çπ„Éà„É©„É™„Ç¢', r:'„Åä„Éº„Åô„Å®„Çâ„Çä„ÅÇ', e:'Australia'},
  {j:'ÈüìÂõΩ', r:'„Åã„Çì„Åì„Åè', e:'Korea'},
  {j:'„Ç´„Éä„ÉÄ', r:'„Åã„Å™„Å†', e:'Canada'},
  {j:'‰∏≠ÂõΩ', r:'„Å°„ÇÖ„ÅÜ„Åî„Åè', e:'China'},
  {j:'„Ç§„É≥„Éâ', r:'„ÅÑ„Çì„Å©', e:'India'},
  {j:'„Ç®„Ç∏„Éó„Éà', r:'„Åà„Åò„Å∑„Å®', e:'Egypt'},
  {j:'„Éï„Ç£„É™„Éî„É≥', r:'„Åµ„ÅÉ„Çä„Å¥„Çì', e:'Philippines'},
		{j:'„Ç¢„Ç∏„Ç¢Á†îÁ©∂', r:'„ÅÇ„Åò„ÅÇ„Åë„Çì„Åç„ÇÖ„ÅÜ', e:'Asian studies'},
  		{j:'ÁµåÊ∏à', r:'„Åë„ÅÑ„Åñ„ÅÑ', e:'economics'},
  		{j:'Â∑•Â≠¶', r:'„Åì„ÅÜ„Åå„Åè', e:'engineering'},
  		{j:'ÂõΩÈöõÈñ¢‰øÇ', r:'„Åì„Åè„Åï„ÅÑ„Åã„Çì„Åë„ÅÑ', e:'international relations'},
  		{j:'„Ç≥„É≥„Éî„É•„Éº„Çø„Éº', r:'„Åì„Çì„Å¥„ÇÖ„ÅÖ„Åü„ÅÅ', e:'computer science'},
  		{j:'ÊîøÊ≤ª', r:'„Åõ„ÅÑ„Åò', e:'politics'},
  		{j:'ÁîüÁâ©Â≠¶', r:'„Åõ„ÅÑ„Å∂„Å§„Åå„Åè', e:'biology'},
  		{j:'„Éì„Ç∏„Éç„Çπ', r:'„Å≥„Åò„Å≠„Åô', e:'business'},
  		{j:'ÊñáÂ≠¶', r:'„Å∂„Çì„Åå„Åè', e:'literature'},
  		{j:'Ê≠¥Âè≤', r:'„Çå„Åç„Åó', e:'history'},
  		{j:'ÂåªËÄÖ', r:'„ÅÑ„Åó„ÇÉ', e:'doctor'},
  		{j:'‰ºöÁ§æÂì°', r:'„Åã„ÅÑ„Åó„ÇÉ„ÅÑ„Çì', e:'office worker'},
  		{j:'ÁúãË≠∑Â∏´', r:'„Åã„Çì„Åî„Åó', e:'nurse'},
  		{j:'È´òÊ†°Áîü', r:'„Åì„ÅÜ„Åì„ÅÜ„Åõ„ÅÑ', e:'high school student'},
  		{j:'‰∏ªÂ©¶', r:'„Åó„ÇÖ„Åµ', e:'housewife'},
 		{j:'Â§ßÂ≠¶Èô¢Áîü', r:'„Å†„ÅÑ„Åå„Åè„ÅÑ„Çì„Åõ„ÅÑ', e:'graduate student'},
  		{j:'ÂºÅË≠∑Â£´', r:'„Åπ„Çì„Åî„Åó', e:'lawyer'},
             	{j:'„ÅäÊØç„Åï„Çì', r:'„Åä„Åã„ÅÇ„Åï„Çì', e:'mother'},
  		{j:'„ÅäÁà∂„Åï„Çì', r:'„Åä„Å®„ÅÜ„Åï„Çì', e:'father'},
  		{j:'„ÅäÂßâ„Åï„Çì', r:'„Åä„Å≠„Åà„Åï„Çì', e:'older sister'},
  		{j:'„ÅäÂÖÑ„Åï„Çì', r:'„Åä„Å´„ÅÑ„Åï„Çì', e:'older brother'},
  		{j:'Â¶π', r:'„ÅÑ„ÇÇ„ÅÜ„Å®', e:'younger sister'},
  		{j:'Âºü', r:'„Åä„Å®„ÅÜ„Å®', e:'younger brother'}
        ]
    },
    'genkiL2': {
        title: '„É¨„ÉÉ„Çπ„É≥2',
        data: [
  { j:'„Åì„Çå', r:'„Åì„Çå', e:'this (as a pronoun)', id:0 },
  { j:'„Åù„Çå', r:'„Åù„Çå', e:'that (as a pronoun)', id:1 },
  { j:'„ÅÇ„Çå', r:'„ÅÇ„Çå', e:'that over there (as a pronoun)', id:2 },
  { j:'„Å©„Çå', r:'„Å©„Çå', e:'which one  (as a pronoun)', id:3 },
  { j:'„Åì„ÅÆ', r:'„Åì„ÅÆ', e:'this ‚Ä¶(as a determiner)', id:4 },
  { j:'„Åù„ÅÆ', r:'„Åù„ÅÆ', e:'that ‚Ä¶(as a determiner)', id:5 },
  { j:'„ÅÇ„ÅÆ', r:'„ÅÇ„ÅÆ', e:'that ‚Ä¶over there(as a determiner)', id:6 },
  { j:'„Å©„ÅÆ', r:'„Å©„ÅÆ', e:'which ‚Ä¶ (as a determiner)', id:7 },
  { j:'„Åì„Åì', r:'„Åì„Åì', e:'here', id:8 },
  { j:'„Åù„Åì', r:'„Åù„Åì', e:'there', id:9 },
  { j:'„ÅÇ„Åù„Åì', r:'„ÅÇ„Åù„Åì', e:'over there', id:10 },
  { j:'„Å©„Åì', r:'„Å©„Åì', e:'where', id:11 },
  { j:'„Å†„Çå', r:'„Å†„Çå', e:'who', id:12 },
  { j:'ÁæéÂë≥„Åó„ÅÑ', r:'„Åä„ÅÑ„Åó„ÅÑ', e:'delicious', id:13 },
  { j:'È≠ö', r:'„Åï„Åã„Å™', e:'fish', id:14 },
  { j:'Ë±ö„Ç´„ÉÑ', r:'„Å®„Çì„Åã„Å§', e:'pork cutlet', id:15 },
  { j:'ËÇâ', r:'„Å´„Åè', e:'meat', id:16 },
  { j:'„É°„Éã„É•„Éº', r:'„ÇÅ„Å´„ÇÖ„ÅÖ', e:'menu', id:17 },
  { j:'ÈáéËèú', r:'„ÇÑ„Åï„ÅÑ', e:'vegetable', id:18 },
  { j:'ÂÇò', r:'„Åã„Åï', e:'umbrella', id:19 },
  { j:'ÈûÑ', r:'„Åã„Å∞„Çì', e:'bag', id:20 },
  { j:'Èù¥', r:'„Åè„Å§', e:'shoes', id:21 },
  { j:'Ë≤°Â∏É', r:'„Åï„ÅÑ„Åµ', e:'wallet', id:22 },
  { j:'„Ç∏„Éº„É≥„Ç∫', r:'„Åò„ÅÉ„Çì„Åö', e:'jeans', id:23 },
  { j:'Ëá™Ëª¢Ëªä', r:'„Åò„Å¶„Çì„Åó„ÇÉ', e:'bicycle', id:24 },
  { j:'Êñ∞ËÅû', r:'„Åó„Çì„Å∂„Çì', e:'newspaper', id:25 },
  { j:'„Çπ„Éû„Éõ', r:'„Åô„Åæ„Åª', e:'smartphone', id:26 },
  { j:'T„Ç∑„É£„ÉÑ', r:'„Å¶„ÅÉ„ÅÉ„Åó„ÇÉ„Å§', e:'T-shirt', id:27 },
  { j:'ÊôÇË®à', r:'„Å®„Åë„ÅÑ', e:'watch; clock', id:28 },
  { j:'„Éé„Éº„Éà', r:'„ÅÆ„Åâ„Å®', e:'notebook', id:29 },
  { j:'„Éö„É≥', r:'„Å∫„Çì', e:'pen', id:30 },
  { j:'Â∏ΩÂ≠ê', r:'„Åº„ÅÜ„Åó', e:'hat; cap', id:31 },
  { j:'Êú¨', r:'„Åª„Çì', e:'book', id:32 },
  { j:'ÈäÄË°å', r:'„Åé„Çì„Åì„ÅÜ', e:'bank', id:33 },
  { j:'„Ç≥„É≥„Éì„Éã', r:'„Åì„Çì„Å≥„Å´', e:'convenience store', id:34 },
  { j:'„Éà„Ç§„É¨', r:'„Å®„ÅÑ„Çå', e:'toilet; restroom', id:35 },
  { j:'Âõ≥Êõ∏È§®', r:'„Å®„Åó„Çá„Åã„Çì', e:'library', id:36 },
  { j:'ÈÉµ‰æøÂ±Ä', r:'„ÇÜ„ÅÜ„Å≥„Çì„Åç„Çá„Åè', e:'post office', id:37 },
  { j:'„Ç§„ÇÆ„É™„Çπ', r:'„ÅÑ„Åé„Çä„Åô', e:'Britain', id:38 },
  { j:'ÈüìÂõΩ', r:'„Åã„Çì„Åì„Åè', e:'Korea', id:39 },
  { j:'‰∏≠ÂõΩ', r:'„Å°„ÇÖ„ÅÜ„Åî„Åè', e:'China', id:40 },
  { j:'Ëã±Ë™û', r:'„Åà„ÅÑ„Åî', e:'English (language)', id:41 },
  { j:'ÁµåÊ∏à', r:'„Åë„ÅÑ„Åñ„ÅÑ', e:'economics', id:42 },
  { j:'„Ç≥„É≥„Éî„É•„Éº„Çø„Éº', r:'„Åì„Çì„Å¥„ÇÖ„ÅÖ„Åü„ÅÅ', e:'computer', id:43 },
  { j:'„Éì„Ç∏„Éç„Çπ', r:'„Å≥„Åò„Å≠„Åô', e:'business', id:44 },
  { j:'Ê≠¥Âè≤', r:'„Çå„Åç„Åó', e:'history', id:45 },
  { j:'„ÅäÊØç„Åï„Çì', r:'„Åä„Åã„ÅÇ„Åï„Çì', e:'mother', id:46 },
  { j:'„ÅäÁà∂„Åï„Çì', r:'„Åä„Å®„ÅÜ„Åï„Çì', e:'father', id:47 },
  { j:'„ÅÑ„Åè„Çâ', r:'„ÅÑ„Åè„Çâ', e:'how much', id:48 },
  { j:'„ÄúÂÜÜ', r:'„Äú„Åà„Çì', e:'‚Ä¶ yen', id:49 },
  { j:'È´ò„ÅÑ', r:'„Åü„Åã„ÅÑ', e:'expensive; high', id:50 },
  { j:'„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ', r:'„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ', e:'Welcome (to our store)', id:51 },
  { j:'Ôºà„Äú„ÇíÔºâ„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô', r:'Ôºà„Äú„ÇíÔºâ„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô', e:'‚Ä¶, please.', id:52 },
  { j:'Ôºà„Äú„ÇíÔºâ„Åè„Å†„Åï„ÅÑ', r:'Ôºà„Äú„ÇíÔºâ„Åè„Å†„Åï„ÅÑ', e:'Please give me ‚Ä¶', id:53 },
  { j:'„Åò„ÇÉ„ÅÇ', r:'„Åò„ÇÉ„ÅÇ', e:'then‚Ä¶; if that‚Äôs the case‚Ä¶', id:54 },
  { j:'„Å©„ÅÜ„Åû', r:'„Å©„ÅÜ„Åû', e:'Please.; Here it is.', id:55 },
  { j:'„Å©„ÅÜ„ÇÇ', r:'„Å©„ÅÜ„ÇÇ', e:'Thank you.', id:56 }
]
},
    'genkiL3': {
        title: '„É¨„ÉÉ„Çπ„É≥3',
        data: [
 { j:'Êò†Áîª', r:'„Åà„ÅÑ„Åå', e:'movie', id:0 },
  { j:'Èü≥Ê•Ω', r:'„Åä„Çì„Åå„Åè', e:'music', id:1 },
  { j:'ÈõëË™å', r:'„Åñ„Å£„Åó', e:'magazine', id:2 },
  { j:'„Çπ„Éù„Éº„ÉÑ', r:'„Åô„ÅΩ„Åâ„Å§', e:'sports', id:3 },
  { j:'„Éá„Éº„Éà', r:'„Åß„Åá„Å®', e:'date (romantic, not calendar)', id:4 },
  { j:'„ÉÜ„Éã„Çπ', r:'„Å¶„Å´„Åô', e:'tennis', id:5 },
  { j:'„ÉÜ„É¨„Éì', r:'„Å¶„Çå„Å≥', e:'TV', id:6 },
  { j:'„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†', r:'„ÅÇ„ÅÑ„Åô„Åè„Çä„ÅÉ„ÇÄ', e:'ice cream', id:7 },
  { j:'„Éè„É≥„Éê„Éº„Ç¨„Éº', r:'„ÅØ„Çì„Å∞„ÅÅ„Åå„ÅÅ', e:'hamburger', id:8 },
  { j:'„ÅäÈÖí', r:'„Åä„Åï„Åë', e:'sake; alcoholic drink', id:9 },
  { j:'„ÅäËå∂', r:'„Åä„Å°„ÇÉ', e:'green tea', id:10 },
  { j:'„Ç≥„Éº„Éí„Éº', r:'„Åì„Åâ„Å≤„ÅÉ', e:'coffee', id:11 },
  { j:'Ê∞¥', r:'„Åø„Åö', e:'water', id:12 },
  { j:'Êúù„ÅîÈ£Ø', r:'„ÅÇ„Åï„Åî„ÅØ„Çì', e:'breakfast', id:13 },
  { j:'Êòº„ÅîÈ£Ø', r:'„Å≤„Çã„Åî„ÅØ„Çì', e:'lunch', id:14 },
  { j:'Êô©„ÅîÈ£Ø', r:'„Å∞„Çì„Åî„ÅØ„Çì', e:'dinner', id:15 },
  { j:'ÂÆ∂', r:'„ÅÑ„Åà', e:'home; house', id:16 },
  { j:'ÂÆ∂/ÂÜÖ', r:'„ÅÜ„Å°', e:'home; house; my place', id:17 },
  { j:'Â≠¶Ê†°', r:'„Åå„Å£„Åì„ÅÜ', e:'school', id:18 },
  { j:'Âñ´Ëå∂Â∫ó', r:'„Åç„Å£„Åï„Å¶„Çì', e:'tea plce/caf√©', id:19 },
  { j:'ÊòéÊó•', r:'„ÅÇ„Åó„Åü', e:'tomorrow', id:20 },
  { j:'‰ªäÊó•', r:'„Åç„Çá„ÅÜ', e:'today', id:21 },
  { j:'Êúù', r:'„ÅÇ„Åï', e:'morning', id:22 },
  { j:'‰ªäÊô©', r:'„Åì„Çì„Å∞„Çì', e:'tonight', id:23 },
  { j:'ÊØéÊó•', r:'„Åæ„ÅÑ„Å´„Å°', e:'every day', id:24 },
  { j:'ÊØéÊô©', r:'„Åæ„ÅÑ„Å∞„Çì', e:'every night', id:25 },
  { j:'ÈÄ±Êú´', r:'„Åó„ÇÖ„ÅÜ„Åæ„Å§', e:'weekend', id:26 },
  { j:'ÂúüÊõúÊó•', r:'„Å©„Çà„ÅÜ„Å≥', e:'Saturday', id:27 },
  { j:'Êó•ÊõúÊó•', r:'„Å´„Å°„Çà„ÅÜ„Å≥', e:'Sunday', id:28 },
  { j:'Ë°å„Åè', r:'„ÅÑ„Åè', e:'to go', id:29 },
  { j:'Â∏∞„Çã', r:'„Åã„Åà„Çã', e:'to go back; to return', id:30 },
  { j:'ËÅû„Åè', r:'„Åç„Åè', e:'to listen; to hear', id:31 },
  { j:'È£≤„ÇÄ', r:'„ÅÆ„ÇÄ', e:'to drink', id:32 },
  { j:'Ë©±„Åô', r:'„ÅØ„Å™„Åô', e:'to speak; to talk', id:33 },
  { j:'Ë™≠„ÇÄ', r:'„Çà„ÇÄ', e:'to read', id:34 },
  { j:'Ëµ∑„Åç„Çã', r:'„Åä„Åç„Çã', e:'to get up', id:35 },
  { j:'È£ü„Åπ„Çã', r:'„Åü„Åπ„Çã', e:'to eat', id:36 },
  { j:'ÂØù„Çã', r:'„Å≠„Çã', e:'to sleep; to go to sleep', id:37 },
  { j:'Ë¶ã„Çã', r:'„Åø„Çã', e:'to see; to look at; to watch', id:38 },
  { j:'Êù•„Çã', r:'„Åè„Çã', e:'to come', id:39 },
  { j:'„Åô„Çã', r:'„Åô„Çã', e:'to do', id:40 },
  { j:'ÂãâÂº∑„Åô„Çã', r:'„Åπ„Çì„Åç„Çá„ÅÜ„Åô„Çã', e:'to study', id:41 },
  { j:'„ÅÑ„ÅÑ', r:'„ÅÑ„ÅÑ', e:'good', id:42 },
  { j:'Êó©„ÅÑ', r:'„ÅØ„ÇÑ„ÅÑ', e:'early', id:43 },
  { j:'„ÅÇ„Åæ„Çä', r:'„ÅÇ„Åæ„Çä', e:'not much (used with negative)', id:44 },
  { j:'ÂÖ®ÁÑ∂', r:'„Åú„Çì„Åú„Çì', e:'not at all (used with negative)', id:45 },
  { j:'Â§ßÊäµ', r:'„Åü„ÅÑ„Å¶„ÅÑ', e:'usually', id:46 },
  { j:'„Å°„Çá„Å£„Å®', r:'„Å°„Çá„Å£„Å®', e:'a little', id:47 },
  { j:'ÊôÇ„ÄÖ', r:'„Å®„Åç„Å©„Åç', e:'sometimes', id:48 },
  { j:'„Çà„Åè', r:'„Çà„Åè', e:'often; much', id:49 },
  { j:'„Åù„ÅÜ„Åß„Åô„Å≠', r:'„Åù„ÅÜ„Åß„Åô„Å≠', e:"That's right.; Let me see.", id:50 },
  { j:'„Åß„ÇÇ', r:'„Åß„ÇÇ', e:'but', id:51 },
  { j:'„Å©„ÅÜ„Åß„Åô„Åã', r:'„Å©„ÅÜ„Åß„Åô„Åã', e:'How about...? / How is‚Ä¶?', id:52 },
  { j:'„ÅØ„ÅÑ', r:'„ÅØ„ÅÑ', e:'yes', id:53 },
  { j:'„Äú„Å∏', r:'„Å™„Å´„Å™„Å´„Å∏', e:'to (direction)', id:54 },
  { j:'„Äú„Åß', r:'„Å™„Å´„Å™„Å´„Åß', e:'at‚Ä¶; in‚Ä¶; with‚Ä¶(the tool/by the mean of...)', id:55 },
  { j:'„ÅÑ„Å§', r:'„ÅÑ„Å§', e:'when', id:56 },
  { j:'„ÄúÈ†É', r:'„Äú„Åî„Çç', e:'at about‚Ä¶', id:57 },
  { j:'„Ç´„Éï„Çß', r:'„Åã„Åµ„Åá', e:'caf√©', id:58 }
]
},
'genkiL4': {
    title: '„É¨„ÉÉ„Çπ„É≥4',
    data: [
        {j:'„Ç≤„Éº„É†', r:'„Åí„Åá„ÇÄ', e:'game', id:0},
        {j:'„Ç¢„É´„Éê„Ç§„Éà', r:'„ÅÇ„Çã„Å∞„ÅÑ„Å®', e:'part-time job (more colloquially, „Éê„Ç§„Éà)', id:1},
        {j:'Ë≤∑„ÅÑÁâ©', r:'„Åã„ÅÑ„ÇÇ„ÅÆ', e:'shopping', id:2},
        {j:'„ÇØ„É©„Çπ', r:'„Åè„Çâ„Åô', e:'class', id:3},
        {j:'Áä¨', r:'„ÅÑ„Å¨', e:'dog', id:4},
        {j:'Áå´', r:'„Å≠„Åì', e:'cat', id:5},
        {j:'‰∫∫', r:'„Å≤„Å®', e:'person', id:6},
        {j:'Â≠ê‰æõ', r:'„Åì„Å©„ÇÇ', e:'child', id:7},
        {j:'„ÅÇ„Å™„Åü', r:'„ÅÇ„Å™„Åü', e:'you', id:8},
        {j:'Ê§ÖÂ≠ê', r:'„ÅÑ„Åô', e:'chair', id:9},
        {j:'Êú∫', r:'„Å§„Åè„Åà', e:'desk', id:10},
        {j:'ÂÜôÁúü', r:'„Åó„ÇÉ„Åó„Çì', e:'picture; photograph', id:11},
        {j:'Ëä±', r:'„ÅØ„Å™', e:'flower', id:12},
        {j:'„É¨„Éù„Éº„Éà', r:'„Çå„ÅΩ„Åâ„Å®', e:'(term) paper', id:13},
        {j:'„ÅîÈ£Ø', r:'„Åî„ÅØ„Çì', e:'rice; meal', id:14},
        {j:'„Éë„É≥', r:'„Å±„Çì', e:'bread', id:15},
        {j:'„ÅäÂØ∫', r:'„Åä„Å¶„Çâ', e:'temple', id:16},
        {j:'ÂÖ¨Âúí', r:'„Åì„ÅÜ„Åà„Çì', e:'park', id:17},
        {j:'„Çπ„Éº„Éë„Éº', r:'„Åô„ÅÖ„Å±„ÅÅ', e:'supermarket', id:18},
        {j:'„Éê„ÇπÂÅú', r:'„Å∞„Åô„Å¶„ÅÑ', e:'bus stop', id:19},
        {j:'ÁóÖÈô¢', r:'„Å≥„Çá„ÅÜ„ÅÑ„Çì', e:'hospital', id:20},
        {j:'„Éõ„ÉÜ„É´', r:'„Åª„Å¶„Çã', e:'hotel', id:21},
        {j:'Êú¨Â±ã', r:'„Åª„Çì„ÇÑ', e:'bookstore', id:22},
        {j:'Áî∫', r:'„Åæ„Å°', e:'town; city', id:23},
        {j:'„É¨„Çπ„Éà„É©„É≥', r:'„Çå„Åô„Å®„Çâ„Çì', e:'restaurant', id:24},
        {j:'Êò®Êó•', r:'„Åç„ÅÆ„ÅÜ', e:'yesterday', id:25},
        {j:'„ÄúÊôÇÈñì', r:'„Äú„Åò„Åã„Çì', e:'.. hours(hr counter)', id:26},
        {j:'‰∏ÄÊôÇÈñì', r:'„ÅÑ„Å°„Åò„Åã„Çì', e:'one hour', id:27},
        {j:'ÂÖàÈÄ±', r:'„Åõ„Çì„Åó„ÇÖ„ÅÜ', e:'last week', id:28},
        {j:'ÊôÇ', r:'„Å®„Åç', e:'when...; at the time of... (~„ÅÆ)', id:29},
        {j:'ÊúàÊõúÊó•', r:'„Åí„Å§„Çà„ÅÜ„Å≥', e:'Monday', id:30},
        {j:'ÁÅ´ÊõúÊó•', r:'„Åã„Çà„ÅÜ„Å≥', e:'Tuesday', id:31},
        {j:'Ê∞¥ÊõúÊó•', r:'„Åô„ÅÑ„Çà„ÅÜ„Å≥', e:'Wednesday', id:32},
        {j:'Êú®ÊõúÊó•', r:'„ÇÇ„Åè„Çà„ÅÜ„Å≥', e:'Thursday', id:33},
        {j:'ÈáëÊõúÊó•', r:'„Åç„Çì„Çà„ÅÜ„Å≥', e:'Friday', id:34},
        {j:'‰ºö„ÅÜ', r:'„ÅÇ„ÅÜ', e:'to meet; to see (a person) (person„Å´)', id:35},
        {j:'„ÅÇ„Çã', r:'„ÅÇ„Çã', e:'there is... (place„Å´thing„Åå)', id:36},
        {j:'Ë≤∑„ÅÜ', r:'„Åã„ÅÜ', e:'to buy (~„Çí)', id:37},
        {j:'Êõ∏„Åè', r:'„Åã„Åè', e:'to write (person„Å´thing„Çí)', id:38},
        {j:'ÊíÆ„Çã', r:'„Å®„Çã', e:'to take (a picture) (~„Çí)', id:39},
        {j:'ÂæÖ„Å§', r:'„Åæ„Å§', e:'to wait (~„Çí)', id:40},
        {j:'ÂàÜ„Åã„Çã', r:'„Çè„Åã„Çã', e:'to understand (~„Åå)', id:41},
        {j:'Â±Ö„Çã', r:'„ÅÑ„Çã', e:'(a person) is in...; stays at... (place „Å´ person„Åå)', id:42},
        {j:'Âè≥', r:'„Åø„Åé', e:'right (~„ÅÆ)', id:43},
        {j:'Â∑¶', r:'„Å≤„Å†„Çä', e:'left (~„ÅÆ)', id:44},
        {j:'Ââç', r:'„Åæ„Åà', e:'front (~„ÅÆ)', id:45},
        {j:'Âæå„Çç', r:'„ÅÜ„Åó„Çç', e:'back (~„ÅÆ)', id:46},
        {j:'‰∏≠', r:'„Å™„Åã', e:'inside (~„ÅÆ)', id:47},
        {j:'‰∏ä', r:'„ÅÜ„Åà', e:'on (~„ÅÆ)', id:48},
        {j:'‰∏ã', r:'„Åó„Åü', e:'under (~„ÅÆ)', id:49},
        {j:'Ëøë„Åè', r:'„Å°„Åã„Åè', e:'near; nearby (~„ÅÆ)', id:50},
        {j:'Èö£', r:'„Å®„Å™„Çä', e:'next (~„ÅÆ)', id:51},
        {j:'Èñì', r:'„ÅÇ„ÅÑ„Å†', e:'between (A„Å®B„ÅÆ)', id:52},
        {j:'„Äú„Åê„Çâ„ÅÑ', r:'„Äú„Åê„Çâ„ÅÑ', e:'about (approximate measurement)', id:53},
        {j:'„ÅîÂÖç„Å™„Åï„ÅÑ', r:'„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ', e:"I'm sorry.", id:54},
        {j:'„Åù„Çå„Åã„Çâ', r:'„Åù„Çå„Åã„Çâ', e:'and then', id:55},
        {j:'„Å†„Åã„Çâ', r:'„Å†„Åã„Çâ', e:'so; therefore', id:56},
        {j:'Ê≤¢Â±±', r:'„Åü„Åè„Åï„Çì', e:'many; a lot', id:57},
        {j:'„Äú„Å®', r:'„Äú„Å®', e:'and/with (conj. particle); and', id:58},
        {j:'„Å©„ÅÜ„Åó„Å¶', r:'„Å©„ÅÜ„Åó„Å¶', e:'why', id:59},
        {j:'‰∏Ä‰∫∫„Åß', r:'„Å≤„Å®„Çä„Åß', e:'alone', id:60},
        {j:'„ÇÇ„Åó„ÇÇ„Åó', r:'„ÇÇ„Åó„ÇÇ„Åó', e:'Hello? (used on the phone)', id:61}
    ]
},
'genkiL5': {
        title: '„É¨„ÉÉ„Çπ„É≥5',
        data: [
	{j:'È£ü„ÅπÁâ©', r:'„Åü„Åπ„ÇÇ„ÅÆ', e:'food', id:0},
        {j:'È£≤„ÅøÁâ©', r:'„ÅÆ„Åø„ÇÇ„ÅÆ', e:'drink', id:1},
        {j:'ÊûúÁâ©', r:'„Åè„Å†„ÇÇ„ÅÆ', e:'fruit', id:2},
        {j:'‰ºë„Åø', r:'„ÇÑ„Åô„Åø', e:'holiday; day off; absence', id:3},
        {j:'ÊóÖË°å', r:'„Çä„Çá„Åì„ÅÜ', e:'travel', id:4},
        {j:'Êµ∑', r:'„ÅÜ„Åø', e:'sea', id:5},
        {j:'„Çµ„Éº„Éï„Ç£„É≥', r:'„Åï„ÅÅ„Åµ„ÅÉ„Çì', e:'surfing', id:6},
        {j:'„ÅäÂúüÁî£', r:'„Åä„Åø„ÇÑ„Åí', e:'souvenir', id:7},
        {j:'„Éê„Çπ', r:'„Å∞„Åô', e:'bus', id:8},
        {j:'Â§©Ê∞ó', r:'„Å¶„Çì„Åç', e:'weather', id:9},
        {j:'„ÉÜ„Çπ„Éà', r:'„Å¶„Åô„Å®', e:'test', id:10},
        {j:'ÂÆøÈ°å', r:'„Åó„ÇÖ„Åè„Å†„ÅÑ', e:'homework', id:11},
        {j:'Ë™ïÁîüÊó•', r:'„Åü„Çì„Åò„Çá„ÅÜ„Å≥', e:'birthday', id:12},
        {j:'ÈÉ®Â±ã', r:'„Å∏„ÇÑ', e:'room', id:13},
        {j:'ÂÉï', r:'„Åº„Åè', e:'I (used by men)', id:14},
        {j:'Êñ∞„Åó„ÅÑ', r:'„ÅÇ„Åü„Çâ„Åó„ÅÑ', e:'new', id:15},
        {j:'Âè§„ÅÑ', r:'„Åµ„Çã„ÅÑ', e:'old (thing-not used for people)', id:16},
        {j:'Êöë„ÅÑ', r:'„ÅÇ„Å§„ÅÑ', e:'hot (weather)', id:17},
        {j:'ÂØí„ÅÑ', r:'„Åï„ÇÄ„ÅÑ', e:'cold (weather-not used for things)', id:18},
        {j:'ÁÜ±„ÅÑ', r:'„ÅÇ„Å§„ÅÑ', e:'hot (thing)', id:19},
        {j:'Âøô„Åó„ÅÑ', r:'„ÅÑ„Åù„Åå„Åó„ÅÑ', e:'busy (people/days)', id:20},
        {j:'Â§ß„Åç„ÅÑ', r:'„Åä„Åä„Åç„ÅÑ', e:'large', id:21},
        {j:'Â∞è„Åï„ÅÑ', r:'„Å°„ÅÑ„Åï„ÅÑ', e:'small', id:22},
        {j:'Èù¢ÁôΩ„ÅÑ', r:'„Åä„ÇÇ„Åó„Çç„ÅÑ', e:'interesting; funny', id:23},
        {j:'„Å§„Åæ„Çâ„Å™„ÅÑ', r:'„Å§„Åæ„Çâ„Å™„ÅÑ', e:'boring', id:24},
        {j:'„ÇÑ„Åï„Åó„ÅÑ', r:'„ÇÑ„Åï„Åó„ÅÑ', e:'easy (problem); kind (person)', id:25},
        {j:'Èõ£„Åó„ÅÑ', r:'„ÇÄ„Åö„Åã„Åó„ÅÑ', e:'difficult', id:26},
        {j:'„Åã„Å£„Åì„ÅÑ„ÅÑ', r:'„Åã„Å£„Åì„ÅÑ„ÅÑ', e:'good-looking (conjugates like „ÅÑ„ÅÑ)', id:27},
        {j:'ÊÄñ„ÅÑ', r:'„Åì„Çè„ÅÑ', e:'frightening', id:28},
        {j:'Ê•Ω„Åó„ÅÑ', r:'„Åü„ÅÆ„Åó„ÅÑ', e:'fun', id:29},
        {j:'ÂÆâ„ÅÑ', r:'„ÇÑ„Åô„ÅÑ', e:'inexpensive; cheap (thing)', id:30},
        {j:'Â•Ω„Åç(„Å™)', r:'„Åô„Åç(„Å™)', e:'fond of; to like (~„Åå)', id:31},
        {j:'Â´å„ÅÑ(„Å™)', r:'„Åç„Çâ„ÅÑ(„Å™)', e:'disgusted with; to dislike (~„Åå)', id:32},
        {j:'Â§ßÂ•Ω„Åç(„Å™)', r:'„Å†„ÅÑ„Åô„Åç(„Å™)', e:'very fond of; to love (~„Åå)', id:33},
        {j:'Â§ßÂ´å„ÅÑ(„Å™)', r:'„Å†„ÅÑ„Åç„Çâ„ÅÑ(„Å™)', e:'to hate (~„Åå)', id:34},
        {j:'Á∂∫È∫ó(„Å™)', r:'„Åç„Çå„ÅÑ(„Å™)', e:'beautiful; clean', id:35},
        {j:'ÂÖÉÊ∞ó(„Å™)', r:'„Åí„Çì„Åç(„Å™)', e:'healthy; energetic', id:36},
        {j:'Èùô„Åã(„Å™)', r:'„Åó„Åö„Åã(„Å™)', e:'quiet', id:37},
        {j:'Ë≥ë„ÇÑ„Åã(„Å™)', r:'„Å´„Åé„ÇÑ„Åã(„Å™)', e:'lively', id:38},
        {j:'Êöá(„Å™)', r:'„Å≤„Åæ(„Å™)', e:'not busy; free (time)', id:39},
        {j:'Ê≥≥„Åê', r:'„Åä„Çà„Åê', e:'to swim', id:40},
        {j:'ËÅû„Åè', r:'„Åç„Åè', e:'to ask (person„Å´)', id:41},
        {j:'‰πó„Çã', r:'„ÅÆ„Çã', e:'to ride; to board (~„Å´)', id:42},
        {j:'„ÇÑ„Çã', r:'„ÇÑ„Çã', e:'to do; to perform (~„Çí)', id:43},
        {j:'Âá∫„Åã„Åë„Çã', r:'„Åß„Åã„Åë„Çã', e:'to go out', id:44},
        {j:'‰∏ÄÁ∑í„Å´', r:'„ÅÑ„Å£„Åó„Çá„Å´', e:'together', id:45},
        {j:'„Åô„Åî„Åè', r:'„Åô„Åî„Åè', e:'extremely', id:46},
        {j:'Â§ß‰∏àÂ§´', r:'„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂', e:"It's okay.; Not to worry.; Everything is under control.", id:47},
        {j:'„Å®„Å¶„ÇÇ', r:'„Å®„Å¶„ÇÇ', e:'very', id:48},
        {j:'„Å©„Çì„Å™', r:'„Å©„Çì„Å™', e:'what kind of...', id:49},
        {j:'„ÄúÊûö', r:'„Äú„Åæ„ÅÑ', e:'[counter for flat objects]', id:50},
        {j:'L„Çµ„Ç§„Ç∫', r:'„Åà„Çã„Åï„ÅÑ„Åö', e:'size L', id:51}
    ]
},
'genkiL6': {
    title: '„É¨„ÉÉ„Çπ„É≥6',
    data: [
        {j:'Êº¢Â≠ó', r:'„Åã„Çì„Åò', e:'kanji; Chinese character', id:0},
        {j:'ÊïôÁßëÊõ∏', r:'„Åç„Çá„ÅÜ„Åã„Åó„Çá', e:'textbook', id:1},
        {j:'„Éö„Éº„Ç∏', r:'„Å∫„Åá„Åò', e:'page', id:2},
        {j:'Ê¨°', r:'„Å§„Åé', e:'next', id:3},
        {j:'„ÅäÈáë', r:'„Åä„Åã„Å≠', e:'money', id:4},
        {j:'Ëç∑Áâ©', r:'„Å´„ÇÇ„Å§', e:'baggage', id:5},
        {j:'„Éë„ÇΩ„Ç≥„É≥', r:'„Å±„Åù„Åì„Çì', e:'personal computer', id:6},
        {j:'„Ç∑„É£„ÉØ„Éº', r:'„Åó„ÇÉ„Çè„ÅÅ', e:'shower', id:7},
        {j:'„Ç®„Ç¢„Ç≥„É≥', r:'„Åà„ÅÅ„Åì„Çì', e:'air conditioner', id:8},
        {j:'ÈõªÊ∞ó', r:'„Åß„Çì„Åç', e:'electricity; light', id:9},
        {j:'Á™ì', r:'„Åæ„Å©', e:'window', id:10},
        {j:'ÈõªËªä', r:'„Åß„Çì„Åó„ÇÉ', e:'train', id:11},
        {j:'ÂõΩ', r:'„Åè„Å´', e:'country; place of origin', id:12},
        {j:'‰ªäÈÄ±', r:'„Åì„Çì„Åó„ÇÖ„ÅÜ', e:'this week', id:13},
        {j:'Êù•ÈÄ±', r:'„Çâ„ÅÑ„Åó„ÇÖ„ÅÜ', e:'next week', id:14},
        {j:'Êù•Âπ¥', r:'„Çâ„ÅÑ„Å≠„Çì', e:'next year', id:15},
        {j:'Â§ú', r:'„Çà„Çã', e:'night', id:16},
        {j:'Â§ßÂ§â(„Å™)', r:'„Åü„ÅÑ„Å∏„Çì(„Å™)', e:'tough (situation)', id:17},
        {j:'ÈÅä„Å∂', r:'„ÅÇ„Åù„Å∂', e:'to play; to spend time pleasantly', id:18},
        {j:'ÊÄ•„Åê', r:'„ÅÑ„Åù„Åê', e:'to hurry', id:19},
        {j:'Ëøî„Åô', r:'„Åã„Åà„Åô', e:'to return (a thing) (person„Å´thing„Çí)', id:20},
        {j:'Ê∂à„Åô', r:'„Åë„Åô', e:'to turn off; to erase (~„Çí)', id:21},
        {j:'Ê≠ª„Å¨', r:'„Åó„Å¨', e:'to die', id:22},
        {j:'Â∫ß„Çã', r:'„Åô„Çè„Çã', e:'to sit down (seat„Å´)', id:23},
        {j:'Á´ã„Å§', r:'„Åü„Å§', e:'to stand up', id:24},
        {j:'„Åü„Å∞„Åì„ÇíÂê∏„ÅÜ', r:'„Åü„Å∞„Åì„Çí„Åô„ÅÜ', e:'to smoke', id:25},
        {j:'‰Ωø„ÅÜ', r:'„Å§„Åã„ÅÜ', e:'to use (~„Çí)', id:26},
        {j:'Êâã‰ºù„ÅÜ', r:'„Å¶„Å§„Å†„ÅÜ', e:'to help (person/task„Çí)', id:27},
        {j:'ÂÖ•„Çã', r:'„ÅØ„ÅÑ„Çã', e:'to enter (~„Å´)', id:28},
        {j:'ÊåÅ„Å§', r:'„ÇÇ„Å§', e:'to carry; to hold (~„Çí)', id:29},
        {j:'‰ºë„ÇÄ', r:'„ÇÑ„Åô„ÇÄ', e:'(1) to be absent (from...) (~„Çí) (2) to rest', id:30},
        {j:'Èñã„Åë„Çã', r:'„ÅÇ„Åë„Çã', e:'to open (something)', id:31},
        {j:'Èñâ„ÇÅ„Çã', r:'„Åó„ÇÅ„Çã', e:'to close (something)', id:32},
        {j:'Êïô„Åà„Çã', r:'„Åä„Åó„Åà„Çã', e:'to teach; to instruct', id:33},
        {j:'Âøò„Çå„Çã', r:'„Çè„Åô„Çå„Çã', e:'to forget', id:34},
        {j:'Èôç„Çä„Çã', r:'„Åä„Çä„Çã', e:'to get off (from a vehicle)', id:35},
        {j:'„Ç∑„É£„ÉØ„Éº„ÇíÊµ¥„Å≥„Çã', r:'„Åó„ÇÉ„Çè„ÅÅ„Çí„ÅÇ„Å≥„Çã', e:'to take a shower', id:36},
        {j:'ÁÇπ„Åë„Çã', r:'„Å§„Åë„Çã', e:'to turn on (something)', id:37},
        {j:'ÈõªË©±„Çí„Åô„Çã', r:'„Åß„Çì„Çè„Çí„Åô„Çã', e:'to phone someone', id:38},
        {j:'ÈÄ£„Çå„Å¶„Åè„Çã', r:'„Å§„Çå„Å¶„Åè„Çã', e:'to bring (someone to come)', id:39},
        {j:'ÊåÅ„Å£„Å¶„Åè„Çã', r:'„ÇÇ„Å£„Å¶„Åè„Çã', e:'to bring (something to come)', id:40},
        {j:'ÈÄ£„Çå„Å¶„ÅÑ„Åè', r:'„Å§„Çå„Å¶„ÅÑ„Åè', e:'to take (someone to go)', id:41},
        {j:'ÊåÅ„Å£„Å¶„ÅÑ„Åè', r:'„ÇÇ„Å£„Å¶„ÅÑ„Åè', e:'to take (something to go)', id:42},
        {j:'Âæå„Åß', r:'„ÅÇ„Å®„Åß', e:'at a later time', id:43},
        {j:'Áõ¥„Åê', r:'„Åô„Åê', e:'right away', id:44},
        {j:'„ÇÜ„Å£„Åè„Çä', r:'„ÇÜ„Å£„Åè„Çä', e:'slowly; leisurely; unhurriedly', id:45},
        {j:'ÁµêÊßã„Åß„Åô', r:'„Åë„Å£„Åì„ÅÜ„Åß„Åô', e:"that would be fine; won't be necessary", id:46},
        {j:'Êú¨ÂΩì„Åß„Åô„Åã', r:'„Åª„Çì„Å®„ÅÜ„Åß„Åô„Åã', e:'really?', id:47}
    ]    
}
};

let currentLessonKey = 'greetings'; // Default to the 'greetings' lesson
let vocab = allLessons[currentLessonKey].data; // Global vocab variable

/* --- MODIFIED: Initialize correctTracker and vocab data --- */
let correctTracker; // Will be initialized in resetAll/startGame
/* --------------------------------------------------------------------------- */

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function normalizeEng(s){ return s.trim().toLowerCase().replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim(); }

/* --- populate vocab list tab --- */
function renderVocabList(){
  const target = $('#vocabList'); target.innerHTML='';
  vocab.forEach((w,i)=>{
    const row = document.createElement('div'); row.className='vocab-row';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-size:20px">${w.j} <span style="font-size:12px;color:var(--muted)">(${w.r})</span></div><div style="font-size:15px;color:var(--muted)">${w.e}</div>`;
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='üîä';
    btn.addEventListener('click', ()=> speak(w.r));
    row.appendChild(left); row.appendChild(btn); target.appendChild(row);
  });
  $('#vocabListTitle').textContent = `Vocabulary ‚Äî ${allLessons[currentLessonKey].title}`;
}

/* --- Flashcards --- */
let flashOrder = shuffle([...vocab]);
let flashIndex = 0;
function showFlash(){
  if(flashOrder.length===0) flashOrder = shuffle([...vocab]);
  const w = flashOrder[flashIndex % flashOrder.length];
  $('#flashJP').textContent = w.j;
  $('#flashReading').textContent = `(${w.r})`;
  $('#flashEN').textContent = w.e;
}
$('#nextFlash').addEventListener('click', ()=>{ flashIndex=(flashIndex+1)%flashOrder.length; showFlash(); });
$('#prevFlash').addEventListener('click', ()=>{ flashIndex=(flashIndex-1+flashOrder.length)%flashOrder.length; showFlash(); });
$('#shuffleFlash').addEventListener('click', ()=>{ flashOrder = shuffle([...vocab]); flashIndex = 0; showFlash(); });
$('#hearFlash').addEventListener('click', ()=>{ speak(flashOrder[flashIndex%flashOrder.length].r); });


/* --- Tabs wiring --- */
$$('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const tab = btn.dataset.tab;
    ['vocab','flash','game'].forEach(t=> document.getElementById(t).style.display = (t===tab ? 'block' : 'none'));
    $$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});
$('#openFlash').addEventListener('click', ()=>{ $('#vocab').style.display='none'; $('#flash').style.display='block'; $('#game').style.display='none'; $$('.tab-btn').forEach(b=>b.classList.remove('active')); $$('.tab-btn').find?.(b=>b.dataset.tab==='flash')?.classList.add('active'); });
$('#openGame').addEventListener('click', ()=>{ $('#vocab').style.display='none'; $('#flash').style.display='none'; $('#game').style.display='block'; $$('.tab-btn').forEach(b=>b.classList.remove('active')); $$('.tab-btn').find?.(b=>b.dataset.tab==='game')?.classList.add('active'); });
$('#openVocabTab').addEventListener('click', ()=>{ $('#vocab').style.display='block'; $('#flash').style.display='none'; $('#game').style.display='none'; $$('.tab-btn').forEach(b=>b.classList.remove('active')); $$('.tab-btn').find?.(b=>b.dataset.tab==='vocab')?.classList.add('active'); });


/* --- Lesson Selector Logic --- */
function initLessons(){
    const select = $('#lessonSelect');
    select.innerHTML = '';
    Object.entries(allLessons).forEach(([key, lesson]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = lesson.title;
        select.appendChild(option);
    });

    select.value = currentLessonKey; // Set initial selection
    
    // --- MODIFIED: Added speech to the event listener ---
    select.addEventListener('change', (e) => {
        const key = e.target.value;
        loadLesson(key);
        // Announce the selected lesson title in Japanese
        const speechTitle = allLessons[key].title.replace(/\s*\(.*\)/, '');
        speak(speechTitle + '„Çí„Åõ„Çì„Åü„Åè„Åó„Åæ„Åó„Åü„ÄÇ');
    });
    // --- END MODIFIED ---
    
    loadLesson(currentLessonKey); // Load the initial lesson without speaking
}

function loadLesson(key){
    currentLessonKey = key;
    vocab = allLessons[key].data;
    
    // Update UI
    const title = allLessons[key].title;
    $('#lessonTitle').textContent = `Piled Falling Vocab Game: ${title}`;
    $('#appTitle').textContent = `Puyo-style Falling Vocab Game: ${title}`;
    $('#gameLessonTitle').textContent = title;

    // Reset game state and reload content
    resetAll();
    renderVocabList();
    flashOrder = shuffle([...vocab]);
    flashIndex = 0;
    showFlash();
    updateHUD();
}
/* --- END Lesson Selector Logic --- */


/* --- Game: pile configuration --- */
const cols = 8; // number of columns for stacking
const maxRows = 4; // number rows (height) before game over (with medium blocks)
const colGap = -2;
const pileGrid = $('#pileGrid');
const gameArea = $('#gameArea');
let columns = []; // arrays of stacked blocks per column

function initColumns(){
  columns = [];
  pileGrid.innerHTML = '';
  const areaW = gameArea.clientWidth;
  /* 2. JS COLUMN SPACING */
  const colWidth = 125 + colGap; // 125px is the block width (120) plus internal padding (5)
  const totalWidth = cols * colWidth - colGap;
  const left = (gameArea.clientWidth - totalWidth)/2;
  for(let c=0;c<cols;c++){
    const col = document.createElement('div');
    col.className = 'pile-column';
    col.style.left = (left + c*colWidth) + 'px';
    /* 3. JS COLUMN CONTAINER WIDTH */
    col.style.width = '125px'; // Sets the container width for 120px block + 5px buffer
    col.dataset.index = c;
    pileGrid.appendChild(col);
    columns.push([]);
  }
}
initColumns();
window.addEventListener('resize', ()=> initColumns());

/* game state */
let running=false;
let spawnTimer=null;
let currentWord=null;
let nextWord=null;
let score=0, lives=maxRows, streak=0;
let fallSpeedMult = 1.0; // speed select
let paused=false;

// TIMER STATE VARIABLES
let countdownInterval = null;
let timeLeft = 5;
const TIME_PER_WORD = 5; // Base time allowed per word

/* helper to pick next word (looping) */
let vocabQueue = shuffle([...vocab]);
function pickNext(){
  if(vocabQueue.length===0) vocabQueue = shuffle([...vocab]);
  return vocabQueue.shift();
}

/* render answer buttons (responsive) */
function renderOptionsFor(word){
  const area = $('#answerArea'); area.innerHTML='';
  const correct = word.e;
  const others = shuffle(vocab.filter(v=>v.e !== correct)).slice(0,3).map(x=>x.e);
  const options = shuffle([correct, ...others]);
  const narrow = window.innerWidth < 700;
  if(narrow){
    const grid = document.createElement('div'); grid.className = 'choice-grid';
    options.forEach(opt=>{
      const b = document.createElement('button'); b.className='choice-btn'; b.textContent = opt;
      b.addEventListener('click', ()=> handleChoice(b,opt));
      grid.appendChild(b);
    });
    area.appendChild(grid);
  } else {
    options.forEach(opt=>{
      const b = document.createElement('button'); b.className='choice-btn'; b.textContent = opt;
      b.style.flex = '1';
      b.addEventListener('click', ()=> handleChoice(b,opt));
      area.appendChild(b);
    });
  }
}

/* show preview */
function updatePreview(){
  if(!nextWord){ $('#pvContent').textContent = ''; $('#preview').textContent = ''; return; }
  $('#pvContent').textContent = `${nextWord.j} (${nextWord.r}) ‚Äî ${nextWord.e}`;
  $('#preview').textContent = `${nextWord.j} (${nextWord.r})`;
}

/* spawn flow */
function spawnNext(){
  if(countdownInterval) clearInterval(countdownInterval); // Stop any existing timer
  currentWord = nextWord || pickNext();
  nextWord = pickNext();
  updatePreview();
  renderFallingCard(currentWord);
  renderOptionsFor(currentWord);
  startCountdown(); // Start the new countdown
}

/* render falling card visual (top area) */
function renderFallingCard(word){
  // create a visual floating element (not stacked) that indicates the active falling word
  removeFloating();
  /* 4. JS FALLING CARD CENTERING: half of 120px is 60px */
  const el = document.createElement('div'); el.className='block jp'; el.style.position='absolute'; el.style.left = (gameArea.clientWidth/2 - 60) + 'px'; el.style.top='12px'; 
  el.innerHTML = `<div style="font-size:20px">${word.j}</div><div style="font-size:14px;color:var(--muted);margin-top:6px">${word.r}</div>`;
  el.id = 'floating';
  gameArea.appendChild(el);
}

/* remove floating */
function removeFloating(){
  const f = $('#floating'); if(f && f.parentNode) f.parentNode.removeChild(f);
}

// REDEMPTION MECHANIC
function removeFromPile(word) {
  let blocksRemoved = 0;
  // Use the unique Japanese word (j) to find matching blocks in the pile
  const targetJp = word.j; 

  for (let c = 0; c < columns.length; c++) {
    // Filter the column to keep only blocks that *do not* match the target
    const newCol = columns[c].filter(obj => {
      if (obj.word.j === targetJp) {
        // This is a match, remove it from the DOM
        if (obj.node && obj.node.parentNode) {
          obj.node.parentNode.removeChild(obj.node);
          blocksRemoved++;
        }
        return false; // Exclude from newCol
      }
      return true; // Keep in newCol
    });
    columns[c] = newCol;
  }
  
  if (blocksRemoved > 0) {
    // Award 5 points for each block cleared
    score += (blocksRemoved * 5); 
    // Recalculate lives and update HUD
    lives = Math.max(0, maxRows - Math.max(...columns.map(c=>c.length)));
    updateHUD();
    flashSuccess();
  }
}

/* handle correct / wrong selection */
function handleChoice(buttonEl, chosen){
  if(!currentWord) return;

  // STOP THE COUNTDOWN IMMEDIAITELY UPON CHOICE
  if(countdownInterval) clearInterval(countdownInterval);

  const correct = chosen === currentWord.e;
  const allButtons = $('#answerArea').querySelectorAll('.choice-btn');
  allButtons.forEach(b=>b.disabled=true);
  
  // Find the index of the current word in the active vocab list for the tracker
  const currentWordIndex = vocab.findIndex(w => w.j === currentWord.j && w.r === currentWord.r);

  if(correct){
    buttonEl.classList.add('correct');
    
    // Update correctTracker and check for win
    if (currentWordIndex !== -1) {
        correctTracker[currentWordIndex] = true;
    }
    const allCorrect = correctTracker.every(t => t);
    
    // play audio
    speak(currentWord.r);
    // clear floating and award points
    setTimeout(()=> {
      buttonEl.classList.remove('correct');
      score += 10 + Math.floor(streak*2);
      streak++;
      
      // CALL THE REDEMPTION FUNCTION
      removeFromPile(currentWord); 
      
      updateHUD();
      removeFloating();
      
      // Check for win condition
      if (allCorrect) {
        winGame();
        return;
      }

      // spawn next after short delay
      currentWord = null;
      setTimeout(()=>{ if(running) spawnNext(); }, 450);
    }, 420);
  } else {
    buttonEl.classList.add('wrong');
    // animate floating falling into a column
    streak = 0; updateHUD();
    animatePlaceIntoPile(currentWord).then(()=> {
      // after placement, clear floating and spawn next
      buttonEl.classList.remove('wrong');
      currentWord = null;
      setTimeout(()=>{ if(running) spawnNext(); }, 420);
    });
  }
}

/* animate placement into pile (slow fall) */
function animatePlaceIntoPile(word){
  return new Promise(resolve=>{
    // choose column with least height (to be fair)
    const heights = columns.map(col=>col.length);
    let min = Math.min(...heights);
    // prefer columns with min height, random among them
    const candidates = heights.map((h,i)=> h===min ? i : -1).filter(i=>i>=0);
    let colIndex = candidates.length ? candidates[Math.floor(Math.random()*candidates.length)] : Math.floor(Math.random()*cols);
    // create block element that will animate from floating position to column stack position
    const floating = $('#floating');
    if(!floating){ resolve(); return; }
    const rectStart = floating.getBoundingClientRect();
    // compute destination position (column container bottom + offset)
    const colEl = pileGrid.children[colIndex];
    const targetX = parseFloat(colEl.style.left) + 0; // left within gameArea coordinate
    
    /* --- MODIFIED: Adjusted blockVisualHeight based on 100px height --- */
    const blockVisualHeight = 100 + 6; // Block height (100px) + gap (6px). 
    const destY = gameArea.clientHeight - 8 - ((columns[colIndex].length+1) * blockVisualHeight); // bottom minus stack
    
    // create anim element
    const anim = document.createElement('div'); anim.className='block fail';
    anim.style.position = 'absolute';
    // Calculate initial position relative to gameArea
    const gameAreaRect = gameArea.getBoundingClientRect();
    anim.style.left = rectStart.left - gameAreaRect.left + 'px';
    anim.style.top = rectStart.top - gameAreaRect.top + 'px';
    
    /* 5. JS ANIMATION WIDTH */
    anim.style.width = '120px'; // Match block width. 
    anim.style.height = '100px'; // Height remains the same.
    /* -------------------------------------------------------------------------- */
    
    anim.innerHTML = `<div style="font-size:20px">${word.j}</div><div style="font-size:15px;color:var(--muted);margin-top:4px">${word.r}</div>`;
    gameArea.appendChild(anim);
    
    // Animate down & sideways
    const duration = (speedMultiplier()*800) + 300; 
    const start = performance.now();
    const fromX = parseFloat(anim.style.left);
    const fromY = parseFloat(anim.style.top);
    const toX = targetX;
    const toY = destY;

    function frame(now){
      const t = Math.min(1, (now - start) / duration);
      // smooth step easing function
      const eased = t<0.5? 2*t*t : -1 + (4-2*t)*t; 
      anim.style.left = (fromX + (toX - fromX) * eased) + 'px';
      anim.style.top = (fromY + (toY - fromY) * eased) + 'px';
      if(t < 1){
        requestAnimationFrame(frame);
      } else {
        // placement logic
        const block = document.createElement('div'); block.className='block jp';
        block.innerHTML = `<div style="font-size:20px">${word.j}</div><div style="font-size:15px;color:var(--muted);margin-top:4px">${word.r}</div>`;
        
        columns[colIndex].push({word, node:block});
        pileGrid.children[colIndex].appendChild(block);
        
        if(anim.parentNode) anim.parentNode.removeChild(anim);
        removeFloating();
        
        // update lives
        lives = Math.max(0, maxRows - Math.max(...columns.map(c=>c.length)));
        updateHUD();
        flashFail();
        
        // check game over
        if(columns.some(c=>c.length >= maxRows)){
          endGame();
        }
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

/* utilities */
function speedMultiplier(){
  const v = $('#speedSelect').value;
  if(v==='slow') return 1.35;
  if(v==='normal') return 1.0;
  if(v==='fast') return 0.72;
  return 0.55; // veryfast
}

function getTimeLimit(){
  // Time limit is shorter (faster) on faster speed settings
  return Math.round(TIME_PER_WORD * speedMultiplier());
}

/* UI updates */
function updateHUD(){
  $('#score').textContent = score;
  // Update progress based on the current active vocab list
  const correctCount = correctTracker ? correctTracker.filter(t => t).length : 0;
  $('#lives').textContent = `${Math.max(0, maxRows - Math.max(...columns.map(c=>c.length)))} (${correctCount}/${vocab.length})`;
  $('#streak').textContent = streak;

  // TIMER DISPLAY LOGIC
  const timerEl = $('#timerDisplay');
  timerEl.textContent = `${timeLeft}s`;
  timerEl.classList.toggle('low', timeLeft <= 3);
}

// TIMER LOGIC
function startCountdown(){
  if(countdownInterval) clearInterval(countdownInterval);
  timeLeft = getTimeLimit(); // Set time based on speed setting
  updateHUD();

  countdownInterval = setInterval(()=>{
    if(!running || paused) {
      clearInterval(countdownInterval);
      return;
    }
    timeLeft--;
    updateHUD();

    if(timeLeft <= 0){
      clearInterval(countdownInterval);
      if(currentWord) {
        // Handle Timeout as a wrong answer
        $('#answerArea').querySelectorAll('.choice-btn').forEach(b=>b.disabled=true);
        streak = 0; updateHUD();
        animatePlaceIntoPile(currentWord).then(()=> {
          currentWord = null;
          setTimeout(()=>{ if(running) spawnNext(); }, 420);
        });
      } else {
        // If somehow word is null, just spawn the next one.
        spawnNext();
      }
    }
  }, 1000);
}


/* game start / pause / reset */
function startGame(){
  if(running) return;

  if(countdownInterval) clearInterval(countdownInterval); // Ensure previous timer is cleared
  initColumns();
  running = true; paused=false; score=0; streak=0;
  // Reset correctTracker based on the current active vocab list size
  correctTracker = new Array(vocab.length).fill(false);
  vocabQueue = shuffle([...vocab]);
  currentWord = null; nextWord = pickNext();
  updateHUD();
  spawnNext();
}

function pauseGame(){
  paused = !paused;
  $('#pauseBtn').textContent = paused ? 'Resume' : 'Pause';
  running = !paused;

  // Pause or Resume the interval
  if(paused){
    if(countdownInterval) clearInterval(countdownInterval);
  } else {
    // Resume immediately by restarting the countdown (at the current timeLeft)
    startCountdown(); 
  }
}

function resetAll(){
  running=false; paused=false; $('#pauseBtn').textContent='Pause';
  if(countdownInterval) clearInterval(countdownInterval); // Clear interval on reset
  // clear pile
  initColumns();
  ['#floating'].forEach(id=>{ const el = $(id); if(el && el.parentNode) el.parentNode.removeChild(el); });
  $('#answerArea').innerHTML = '';
  $('#pvContent').textContent = '';
  $('#preview').textContent = '';
  score=0; streak=0;
  // Reset correctTracker on full reset
  correctTracker = new Array(vocab.length).fill(false);
  updateHUD();
}

/* end game */
function endGame(){
  running=false;
  if(countdownInterval) clearInterval(countdownInterval); // Stop timer when game is over
  // overlay
  const overlay = document.createElement('div'); overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.background='linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.45))';
  overlay.innerHTML = `<div style="background:#fff;padding:18px;border-radius:10px;border:1px solid rgba(3,59,73,0.06);text-align:center;color:#04202a"><h2 style="margin:0 0 8px 0">Game Over</h2><div style="margin-bottom:8px">Score: ${score}</div><button id="restartBtn" class="btn">Restart</button></div>`;
  document.querySelector('#game .card').appendChild(overlay);
  $('#restartBtn').addEventListener('click', ()=>{ overlay.remove(); resetAll(); startGame(); });
}

// WIN GAME FUNCTION
function winGame(){
  running=false;
  if(countdownInterval) clearInterval(countdownInterval);
  const overlay = document.createElement('div'); overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.background='linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.45))';
  overlay.innerHTML = `<div style="background:#fff;padding:24px;border-radius:10px;border:1px solid rgba(16,185,129,0.8);text-align:center;color:#04202a;box-shadow: 0 10px 30px rgba(16,185,129,0.2)"><h2 style="margin:0 0 12px 0;color:var(--good)">üéâ Victory! All Words Learned!</h2><div style="margin-bottom:12px;font-size:18px">Final Score: <strong>${score}</strong></div><button id="restartBtn" class="btn" style="background:var(--good);border-color:var(--good);color:white">Play Again</button></div>`;
  document.querySelector('#game .card').appendChild(overlay);
  $('#restartBtn').addEventListener('click', ()=>{ overlay.remove(); resetAll(); startGame(); });
}

/* visual fail flash */
function flashFail(){
  const f = document.createElement('div'); f.className='flash-fail'; gameArea.appendChild(f);
  setTimeout(()=>{ if(f.parentNode) f.parentNode.removeChild(f); }, 420);
}

// VISUAL SUCCESS FLASH
function flashSuccess(){
  const f = document.createElement('div'); f.className='flash-success'; gameArea.appendChild(f);
  setTimeout(()=>{ if(f.parentNode) f.parentNode.removeChild(f); }, 420);
}


/* speech */
function speak(text){
  if(!text) return;
  if('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
   if (selectedVoice) {
  u.voice = selectedVoice;
}
    u.lang = 'ja-JP';
    u.rate = speechRate;
    u.volume = 1.0;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }
}

/* end-of-life wiring */
$('#startBtn').addEventListener('click', ()=>{ resetAll(); startGame(); });
$('#pauseBtn').addEventListener('click', ()=>{ pauseGame(); });
$('#resetBtn').addEventListener('click', ()=>{ resetAll(); });

$('#speedSelect').addEventListener('change', ()=>{ 
  // If the game is running, immediately adjust the timer logic to the new speed
  if(running && !paused && currentWord){
    // Reset timer to the new time limit based on speed
    startCountdown(); 
  }
});

window.addEventListener('resize', ()=>{ initColumns(); if(currentWord) renderOptionsFor(currentWord); });

/* initial setup */
initLessons(); // Initialize and load the default lesson ('greetings')
updateHUD();
function loadVoices() {
  const voiceSelect = document.getElementById("voiceSelect");
  const voices = speechSynthesis.getVoices();

  // Filter Japanese voices (Chrome usually has 2‚Äì4)
  const jpVoices = voices.filter(v => v.lang.includes("ja"));

  // Clear menu
  voiceSelect.innerHTML = "";

  // Add each Japanese voice
  jpVoices.forEach((v, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  });

  // Default to first Japanese voice
  if (jpVoices.length > 0) {
    selectedVoice = jpVoices[0];
  }

  // Update selectedVoice when user changes dropdown
  voiceSelect.addEventListener("change", () => {
    selectedVoice = jpVoices[voiceSelect.value];
  });
}

// Voices sometimes load slowly ‚Äî call twice
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

</script>
</body>
</html>