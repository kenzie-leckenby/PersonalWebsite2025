<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Genki L6 ‚Äî Puyo-style Falling Vocab</title>
<style>
:root{
  --bg-dark:#071033;
  --card:#f1fbff;         /* snow panel */
  --accent:#0ea5c9;
  --muted:#4b6471;
  --good:#16a34a;
  --bad:#ef4444;
  --btn-bg: rgba(14,165,201,0.12);
  --btn-border: rgba(14,165,201,0.45);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Noto Sans JP", "Hiragino Kaku Gothic Pro", system-ui, -apple-system, Arial; -webkit-font-smoothing:antialiased}
body{background:linear-gradient(180deg,#e6f7ff 0%, #eaf9ff 100%);color:#04202a;display:flex;align-items:flex-start;justify-content:center;padding:18px}
.app{width:1200px;max-width:100%;background:linear-gradient(180deg,#ffffff,#f3fbff);border-radius:12px;padding:14px;box-shadow:0 12px 40px rgba(4,32,42,0.08)}
.header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.header h1{margin:0;font-size:20px;color:#033b49}
.tabs{display:flex;gap:8px}
.tab-btn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.tab-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
.controls{display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap}
.controls .small{font-size:15px;color:var(--muted)}
.layout{display:flex;gap:16px;flex-direction:column}
.container{display:block}
.top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.stat{font-size:14px;color:var(--muted)}

/* TIMER STYLES */
.stat.timer-display{
  font-weight:700;
  color:var(--accent);
  font-size:22px;
  padding: 4px 8px;
  border: 1px solid var(--btn-border);
  border-radius: 6px;
}
.stat.timer-display.low{
  color:var(--bad);
  animation: pulseRed 500ms infinite alternate;
}
@keyframes pulseRed{
  from{opacity:1}
  to{opacity:0.75}
}
/* END TIMER STYLES */

.card{background:var(--card);padding:12px;border-radius:10px;min-height:420px;border:1px solid rgba(3,59,73,0.04)}
.game-wrap{display:flex;gap:16px;align-items:flex-start}
.game-area{position:relative;width:100%;height:500px;border-radius:8px;background:linear-gradient(180deg,#dff7ff,#eafcff);overflow:hidden;border:1px solid rgba(3,59,73,0.06);display:flex;align-items:flex-end;justify-content:center;padding-bottom:8px}
.hud{display:flex;gap:14px;align-items:center}
.answer-bar{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
.choice-btn{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(3,59,73,0.06);background:white;cursor:pointer;font-size:20px;color:#063642;font-weight:600;box-shadow:0 6px 18px rgba(6,52,58,0.03)}
.choice-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(6,52,58,0.06)}
.choice-btn.correct{background:var(--good);border:2px solid rgba(16,185,129,0.9);color:white}
.choice-btn.wrong{background:var(--bad);border:2px solid rgba(239,68,68,0.9);color:white}
.choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.preview{width:220px;padding-left:12px}
.preview .pv-title{font-size:15px;color:var(--muted);margin-bottom:8px}
.vocab-list{max-height:420px;overflow:auto}
.vocab-row{padding:8px;border-bottom:1px dashed rgba(3,59,73,0.03);display:flex;justify-content:space-between;align-items:center}
.flash-big-jp{font-size:72px;line-height:1;margin-bottom:6px;color:#033b49}
.flash-reading{font-size:28px;color:var(--muted)}
.flash-eng{font-size:22px;text-align:center;margin-top:10px;color:#04202a}
.small{font-size:12px;color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
.kana-note{font-size:12px;color:var(--muted);margin-top:6px}
.footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
.btn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.btn:hover{background:rgba(14,165,201,0.22);border-color:rgba(14,165,201,0.8);color:white}
@media(max-width:880px){
  .app{padding:10px}
  .game-area{height:520px}
  .preview{display:none}
}
/* pile cell and block styles */
.pile-grid{position:absolute;left:0;right:0;bottom:8px;height:100%;pointer-events:none}
.pile-column{position:absolute;bottom:8px;display:flex;flex-direction:column-reverse;align-items:center;gap:6px}
.block{
  width:110px; /* block width */
  height:120px; /* MEDIUM block height */
  border-radius:8px;
  background:white;
  border:1px solid rgba(3,59,73,0.06);
  box-shadow: 0 6px 18px rgba(6,52,58,0.04);
  display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:6px;font-weight:700;color:#08323a;
  transform-origin:center;
}
.block.jp{background:linear-gradient(180deg,#ffffff,#ecfeff)}
.block.fail{opacity:0.95}
.stack-area{position:absolute;left:0;right:0;bottom:8px;pointer-events:none}
.flash-success{position:absolute;inset:0;background:rgba(16,185,129,0.06);pointer-events:none;animation:fadeOut 420ms forwards}
.flash-fail{position:absolute;inset:0;background:rgba(239,68,68,0.06);pointer-events:none;animation:fadeOut 420ms forwards}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Genki L6 Puyo-style vocab">
    <div class="header">
      <h1>Genki L6 ‚Äî Piled Falling Vocab</h1>
      <div class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="vocab">Vocabulary List</button>
        <button class="tab-btn" data-tab="flash">Flashcards</button>
        <button class="tab-btn" data-tab="game">Game</button>
      </div>

      <div class="controls">
        <div class="small">Mode: <strong id="modeLabel">Japanese ‚Üí English</strong></div>
        <div class="small">Speed:
          <select id="speedSelect" class="small" style="margin-left:6px">
            <option value="slow">Slow</option>
            <option value="normal" selected>Normal</option>
            <option value="fast">Fast</option>
            <option value="veryfast">Very Fast</option>
          </select>
        </div>
        <button id="startBtn" class="btn">Start</button>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>

    <div class="layout">
      <div id="vocab" class="container card" style="display:block">
        <div class="top-row">
          <strong>Vocabulary ‚Äî Genki I Lesson 6 (from your PDF)</strong>
          <div class="small">Click üîä to hear pronunciation</div>
        </div>
        <div class="vocab-list" id="vocabList"></div>
        <div style="margin-top:8px">
          <button id="openFlash" class="btn">Open Flashcards</button>
          <button id="openGame" class="btn">Open Game</button>
        </div>
      </div>

      <div id="flash" class="container card" style="display:none">
        <div class="top-row">
          <strong>Flashcards</strong>
          <div>
            <button id="prevFlash" class="btn">Prev</button>
            <button id="nextFlash" class="btn">Next</button>
            <button id="shuffleFlash" class="btn">Shuffle</button>
            <button id="hearFlash" class="btn">üîä Hear</button>
          </div>
        </div>
        <div class="center" style="flex-direction:column;min-height:360px;justify-content:flex-start">
          <div class="flash-big-jp" id="flashJP">Êº¢Â≠óÔºà„Åã„Å™Ôºâ</div>
          <div class="flash-reading" id="flashReading">(„Åã„Å™)</div>
          <div class="flash-eng" id="flashEN">English meaning</div>
        </div>
      </div>

      <div id="game" class="container" style="display:none">
        <div class="card">
          <div class="top-row">
            <div>
              <strong>Game</strong>
              <div class="small">Japanese (Kanji + reading) falls ‚Äî choose the correct English meaning</div>
            </div>
            <div class="hud">
              <div class="stat">Score: <span id="score">0</span></div>
              <div class="stat">Lives (pile space): <span id="lives">6</span></div>
              <div class="stat">Streak: <span id="streak">0</span></div>
              <div class="stat timer-display" id="timerDisplay">10s</div>
            </div>
          </div>

          <div class="game-wrap">
            <div style="flex:1;position:relative;">
              <div id="gameArea" class="game-area" aria-live="polite">
                <div id="pileGrid" class="pile-grid"></div>
                <div id="stackArea" class="stack-area"></div>
              </div>

              <div id="answerArea" class="answer-bar" style="margin-top:12px"></div>

              <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
                <div class="small">Next:</div>
                <div id="preview" class="small" style="min-width:240px;color:var(--muted)"></div>
                <div class="small">Pile reaches top ‚Üí Game Over</div>
              </div>
            </div>

            <div class="preview" id="sidePreview" aria-hidden="true">
              <div class="pv-title">Preview</div>
              <div id="pvContent" style="font-size:18px;color:var(--muted)"></div>
              <div style="margin-top:12px">
                <button id="openVocabTab" class="btn">Open Vocab</button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>

    <div class="footer">
      <div class="small">Uses browser speech synthesis (Japanese TTS, rate = 0.60). Projection-friendly.</div>
      <div class="small">Responsive: 2√ó2 on narrow screens, horizontal on wide screens.</div>
    </div>
  </div>

<script>
/* ------------------ Genki L6 vocab (from your uploaded PDF) ------------------ */
const vocab = [
  {j:'„ÅäÈáë', r:'„Åä„Åã„Å≠', e:'money'},
  {j:'Ëç∑Áâ©', r:'„Å´„ÇÇ„Å§', e:'baggage, luggage'},
  {j:'„Éë„ÇΩ„Ç≥„É≥', r:'„Éë„ÇΩ„Ç≥„É≥', e:'personal computer'},
  {j:'„Ç∑„É£„ÉØ„Éº', r:'„Ç∑„É£„ÉØ„Éº', e:'shower'},
  {j:'„Ç®„Ç¢„Ç≥„É≥', r:'„Ç®„Ç¢„Ç≥„É≥', e:'air conditioner'},
  {j:'ÈõªÊ∞ó', r:'„Åß„Çì„Åç', e:'electricity; light'},
  {j:'Á™ì', r:'„Åæ„Å©', e:'window'},
  {j:'ÈõªËªä', r:'„Åß„Çì„Åó„ÇÉ', e:'train'},
  {j:'ÂõΩ', r:'„Åè„Å´', e:'country; place of origin'},
  {j:'‰ªäÈÄ±', r:'„Åì„Çì„Åó„ÇÖ„ÅÜ', e:'this week'},
  {j:'Êù•ÈÄ±', r:'„Çâ„ÅÑ„Åó„ÇÖ„ÅÜ', e:'next week'},
  {j:'Êù•Âπ¥', r:'„Çâ„ÅÑ„Å≠„Çì', 'e':'next year'},
  {j:'Â§ú', r:'„Çà„Çã', 'e':'night'},
  {j:'Â§ßÂ§â', r:'„Åü„ÅÑ„Å∏„Çì', 'e':'tough; awful (situation)'},
  {j:'‰∫îÂàÜ', r:'„Åî„Åµ„Çì', 'e':'five minutes'},
  {j:'ÂçÅÂàÜ', r:'„Åò„ÇÖ„Å£„Å∑„Çì', 'e':'ten minutes'},
  {j:'Â§ñÂõΩ', r:'„Åå„ÅÑ„Åì„Åè', 'e':'foreign country'},
  {j:'‰∏≠ÂõΩ', r:'„Å°„ÇÖ„ÅÜ„Åî„Åè', 'e':'China'},
  {j:'ÈÅä„Å∂', r:'„ÅÇ„Åù„Å∂', 'e':'to play; to spend time pleasantly'},
  {j:'ÊÄ•„Åê', r:'„ÅÑ„Åù„Åê', 'e':'to hurry'},
  {j:'Ëøî„Åô', r:'„Åã„Åà„Åô', 'e':'to return (a thing)'},
  {j:'Âá∫„Åô', r:'„Å†„Åô', 'e':'to take out; to hand in'},
  {j:'Ê∂à„Åô', r:'„Åë„Åô', 'e':'to turn off; to erase'},
  {j:'Ê≠ª„Å¨', r:'„Åó„Å¨', 'e':'to die'},
  {j:'Â∫ß„Çã', r:'„Åô„Çè„Çã', 'e':'to sit down'},
  {j:'Á´ã„Å§', r:'„Åü„Å§', 'e':'to stand up'},
  {j:'Âê∏„ÅÜ', r:'„Åô„ÅÜ', 'e':'to smoke'},
  {j:'‰Ωø„ÅÜ', r:'„Å§„Åã„ÅÜ', 'e':'to use'},
  {j:'Êâã‰ºù„ÅÜ', r:'„Å¶„Å§„Å†„ÅÜ', 'e':'to help (person/task)'},
  {j:'ÂÖ•„Çã', r:'„ÅØ„ÅÑ„Çã', 'e':'to enter'},
  {j:'ÊåÅ„Å§', r:'„ÇÇ„Å§', 'e':'to carry; to hold'},
  {j:'‰ºë„ÇÄ', r:'„ÇÑ„Åô„ÇÄ', 'e':'to be absent; to rest'},
  {j:'Èñã„Åë„Çã', r:'„ÅÇ„Åë„Çã', 'e':'to open (something)'},
  {j:'Èñâ„ÇÅ„Çã', r:'„Åó„ÇÅ„Çã', 'e':'to close (something)'},
  {j:'Êïô„Åà„Çã', r:'„Åä„Åó„Åà„Çã', 'e':'to teach; to instruct'},
  {j:'Âøò„Çå„Çã', r:'„Çè„Åô„Çå„Çã', 'e':'to forget; to leave behind'},
  {j:'Èôç„Çä„Çã', r:'„Åä„Çä„Çã', 'e':'to get off'},
  {j:'ÂÄü„Çä„Çã', r:'„Åã„Çä„Çã', 'e':'to borrow'},
  {j:'Êµ¥„Å≥„Çã', r:'„ÅÇ„Å≥„Çã', 'e':'to take a shower'},
  {j:'ÁÇπ„Åë„Çã', r:'„Å§„Åë„Çã', 'e':'to turn on'},
  {j:'ÈõªË©±„Çí„Åã„Åë„Çã', r:'„Åß„Çì„Çè„Çí„Åã„Åë„Çã', 'e':'to make a phone call'},
  {j:'ÈÄ£„Çå„Å¶„Åè„Çã', r:'„Å§„Çå„Å¶„Åè„Çã', 'e':'to bring (a person)'},
  {j:'ÊåÅ„Å£„Å¶„Åè„Çã', r:'„ÇÇ„Å£„Å¶„Åè„Çã', 'e':'to bring (a thing)'},
  {j:'„Åô„Çã', r:'„Åô„Çã', 'e':'to do'},
  {j:'Êù•„Çã', r:'„Åè„Çã', 'e':'to come'},
  {j:'Â§ß„Åç„ÅÑ', r:'„Åä„Åä„Åç„ÅÑ', 'e':'big'},
  {j:'Âæå„Åß', r:'„ÅÇ„Å®„Åß', 'e':'later on'},
  {j:'„Åô„Åê', r:'„Åô„Åê', 'e':'right away'},
  {j:'„ÇÜ„Å£„Åè„Çä', r:'„ÇÜ„Å£„Åè„Çä', 'e':'slowly; leisurely'},
  {j:'„ÅÑ„ÅÑ„Åß„Åô„Çà', r:'„ÅÑ„ÅÑ„Åß„Åô„Çà', 'e':'That would be fine'},
  {j:'Êú¨ÂΩì„Åß„Åô„Åã', r:'„Åª„Çì„Å®„ÅÜ„Åß„Åô„Åã', 'e':'Really?'}
];
/* --------------------------------------------------------------------------- */

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function normalizeEng(s){ return s.trim().toLowerCase().replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim(); }

/* --- populate vocab list tab --- */
function renderVocabList(){
  const target = $('#vocabList'); target.innerHTML='';
  vocab.forEach((w,i)=>{
    const row = document.createElement('div'); row.className='vocab-row';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-size:20px">${w.j} <span style="font-size:12px;color:var(--muted)">(${w.r})</span></div><div style="font-size:15px;color:var(--muted)">${w.e}</div>`;
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='üîä';
    btn.addEventListener('click', ()=> speak(w.r));
    row.appendChild(left); row.appendChild(btn); target.appendChild(row);
  });
}
renderVocabList();

/* --- Flashcards --- */
let flashOrder = shuffle([...vocab]);
let flashIndex = 0;
function showFlash(){
  if(flashOrder.length===0) flashOrder = shuffle([...vocab]);
  const w = flashOrder[flashIndex % flashOrder.length];
  $('#flashJP').textContent = w.j;
  $('#flashReading').textContent = `(${w.r})`;
  $('#flashEN').textContent = w.e;
}
$('#nextFlash').addEventListener('click', ()=>{ flashIndex=(flashIndex+1)%flashOrder.length; showFlash(); });
$('#prevFlash').addEventListener('click', ()=>{ flashIndex=(flashIndex-1+flashOrder.length)%flashOrder.length; showFlash(); });
$('#shuffleFlash').addEventListener('click', ()=>{ flashOrder = shuffle([...vocab]); flashIndex = 0; showFlash(); });
$('#hearFlash').addEventListener('click', ()=>{ speak(flashOrder[flashIndex%flashOrder.length].r); });
showFlash();

/* --- Tabs wiring --- */
$$('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const tab = btn.dataset.tab;
    ['vocab','flash','game'].forEach(t=> document.getElementById(t).style.display = (t===tab ? 'block' : 'none'));
    $$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});
$('#openFlash').addEventListener('click', ()=>{ $('#vocab').style.display='none'; $('#flash').style.display='block'; $('#game').style.display='none'; $$('.tab-btn').forEach(b=>b.classList.remove('active')); $$('.tab-btn').find?.(b=>b.dataset.tab==='flash')?.classList.add('active'); });
$('#openGame').addEventListener('click', ()=>{ $('#vocab').style.display='none'; $('#flash').style.display='none'; $('#game').style.display='block'; $$('.tab-btn').forEach(b=>b.classList.remove('active')); $$('.tab-btn').find?.(b=>b.dataset.tab==='game')?.classList.add('active'); });
$('#openVocabTab').addEventListener('click', ()=>{ $('#vocab').style.display='block'; $('#flash').style.display='none'; $('#game').style.display='none'; $$('.tab-btn').forEach(b=>b.classList.remove('active')); $$('.tab-btn').find?.(b=>b.dataset.tab==='vocab')?.classList.add('active'); });

/* --- Game: pile configuration --- */
const cols = 8; // number of columns for stacking
const maxRows = 4; // number rows (height) before game over (with medium blocks)
const colGap = 8;
const pileGrid = $('#pileGrid');
const gameArea = $('#gameArea');
let columns = []; // arrays of stacked blocks per column

function initColumns(){
  columns = [];
  pileGrid.innerHTML = '';
  const areaW = gameArea.clientWidth;
  const colWidth = 92 + colGap;
  const totalWidth = cols * colWidth - colGap;
  const left = (gameArea.clientWidth - totalWidth)/2;
  for(let c=0;c<cols;c++){
    const col = document.createElement('div');
    col.className = 'pile-column';
    col.style.left = (left + c*colWidth) + 'px';
    col.style.width = '92px';
    col.dataset.index = c;
    pileGrid.appendChild(col);
    columns.push([]);
  }
}
initColumns();
window.addEventListener('resize', ()=> initColumns());

/* game state */
let running=false;
let spawnTimer=null;
let currentWord=null;
let nextWord=null;
let score=0, lives=maxRows, streak=0;
let fallSpeedMult = 1.0; // speed select
let paused=false;

// TIMER STATE VARIABLES
let countdownInterval = null;
let timeLeft = 5;
const TIME_PER_WORD = 5; // Base time allowed per word

/* helper to pick next word (looping) */
let vocabQueue = shuffle([...vocab]);
function pickNext(){
  if(vocabQueue.length===0) vocabQueue = shuffle([...vocab]);
  return vocabQueue.shift();
}

/* render answer buttons (responsive) */
function renderOptionsFor(word){
  const area = $('#answerArea'); area.innerHTML='';
  const correct = word.e;
  const others = shuffle(vocab.filter(v=>v.e !== correct)).slice(0,3).map(x=>x.e);
  const options = shuffle([correct, ...others]);
  const narrow = window.innerWidth < 700;
  if(narrow){
    const grid = document.createElement('div'); grid.className = 'choice-grid';
    options.forEach(opt=>{
      const b = document.createElement('button'); b.className='choice-btn'; b.textContent = opt;
      b.addEventListener('click', ()=> handleChoice(b,opt));
      grid.appendChild(b);
    });
    area.appendChild(grid);
  } else {
    options.forEach(opt=>{
      const b = document.createElement('button'); b.className='choice-btn'; b.textContent = opt;
      b.style.flex = '1';
      b.addEventListener('click', ()=> handleChoice(b,opt));
      area.appendChild(b);
    });
  }
}

/* show preview */
function updatePreview(){
  if(!nextWord){ $('#pvContent').textContent = ''; $('#preview').textContent = ''; return; }
  $('#pvContent').textContent = `${nextWord.j} (${nextWord.r}) ‚Äî ${nextWord.e}`;
  $('#preview').textContent = `${nextWord.j} (${nextWord.r})`;
}

/* spawn flow */
function spawnNext(){
  if(countdownInterval) clearInterval(countdownInterval); // Stop any existing timer
  currentWord = nextWord || pickNext();
  nextWord = pickNext();
  updatePreview();
  renderFallingCard(currentWord);
  renderOptionsFor(currentWord);
  startCountdown(); // Start the new countdown
}

/* render falling card visual (top area) */
function renderFallingCard(word){
  // create a visual floating element (not stacked) that indicates the active falling word
  removeFloating();
  const el = document.createElement('div'); el.className='block jp'; el.style.position='absolute'; el.style.left = (gameArea.clientWidth/2 - 46) + 'px'; el.style.top='12px';
  el.innerHTML = `<div style="font-size:20px">${word.j}</div><div style="font-size:14px;color:var(--muted);margin-top:6px">${word.r}</div>`;
  el.id = 'floating';
  gameArea.appendChild(el);
}

/* remove floating */
function removeFloating(){
  const f = $('#floating'); if(f && f.parentNode) f.parentNode.removeChild(f);
}

// **NEW REDEMPTION MECHANIC**
function removeFromPile(word) {
  let blocksRemoved = 0;
  // Use the unique Japanese word (j) to find matching blocks in the pile
  const targetJp = word.j; 

  for (let c = 0; c < columns.length; c++) {
    // Filter the column to keep only blocks that *do not* match the target
    const newCol = columns[c].filter(obj => {
      if (obj.word.j === targetJp) {
        // This is a match, remove it from the DOM
        if (obj.node && obj.node.parentNode) {
          obj.node.parentNode.removeChild(obj.node);
          blocksRemoved++;
        }
        return false; // Exclude from newCol
      }
      return true; // Keep in newCol
    });
    columns[c] = newCol;
  }
  
  if (blocksRemoved > 0) {
    // Award 5 points for each block cleared
    score += (blocksRemoved * 5); 
    // Recalculate lives and update HUD
    lives = Math.max(0, maxRows - Math.max(...columns.map(c=>c.length)));
    updateHUD();
    flashSuccess();
  }
}
// **END NEW REDEMPTION MECHANIC**

/* handle correct / wrong selection */
function handleChoice(buttonEl, chosen){
  if(!currentWord) return;

  // STOP THE COUNTDOWN IMMEDIAITELY UPON CHOICE
  if(countdownInterval) clearInterval(countdownInterval);

  const correct = chosen === currentWord.e;
  const allButtons = $('#answerArea').querySelectorAll('.choice-btn');
  allButtons.forEach(b=>b.disabled=true);

  if(correct){
    buttonEl.classList.add('correct');
    // play audio
    speak(currentWord.r);
    // clear floating and award points
    setTimeout(()=> {
      buttonEl.classList.remove('correct');
      score += 10 + Math.floor(streak*2);
      streak++;
      
      // *** CALL THE REDEMPTION FUNCTION HERE ***
      removeFromPile(currentWord); 
      // *****************************************
      
      updateHUD();
      removeFloating();
      
      // spawn next after short delay
      currentWord = null;
      setTimeout(()=>{ if(running) spawnNext(); }, 450);
    }, 420);
  } else {
    buttonEl.classList.add('wrong');
    // animate floating falling into a column
    streak = 0; updateHUD();
    animatePlaceIntoPile(currentWord).then(()=> {
      // after placement, clear floating and spawn next
      buttonEl.classList.remove('wrong');
      currentWord = null;
      setTimeout(()=>{ if(running) spawnNext(); }, 420);
    });
  }
}

/* animate placement into pile (slow fall) */
function animatePlaceIntoPile(word){
  return new Promise(resolve=>{
    // choose column with least height (to be fair) or random
    const heights = columns.map(col=>col.length);
    let min = Math.min(...heights);
    // prefer columns with min height, random among them
    const candidates = heights.map((h,i)=> h===min ? i : -1).filter(i=>i>=0);
    let colIndex = candidates.length ? candidates[Math.floor(Math.random()*candidates.length)] : Math.floor(Math.random()*cols);
    // create block element that will animate from floating position to column stack position
    const floating = $('#floating');
    if(!floating){ resolve(); return; }
    const rectStart = floating.getBoundingClientRect();
    // compute destination position (column container bottom + offset)
    const colEl = pileGrid.children[colIndex];
    const targetX = parseFloat(colEl.style.left) + 0; // left within gameArea coordinate
    // The height of a block is 120px in CSS, and the gap is 6px.
    const blockVisualHeight = 120 + 6;
    const destY = gameArea.clientHeight - 8 - ((columns[colIndex].length+1) * blockVisualHeight); // bottom minus stack
    
    // create anim element
    const anim = document.createElement('div'); anim.className='block fail';
    anim.style.position = 'absolute';
    // Calculate initial position relative to gameArea
    const gameAreaRect = gameArea.getBoundingClientRect();
    anim.style.left = rectStart.left - gameAreaRect.left + 'px';
    anim.style.top = rectStart.top - gameAreaRect.top + 'px';
    anim.style.width = '110px'; // Match block width
    anim.style.height = '120px'; // Match block height
    anim.innerHTML = `<div style="font-size:20px">${word.j}</div><div style="font-size:15px;color:var(--muted);margin-top:4px">${word.r}</div>`;
    gameArea.appendChild(anim);
    
    // Animate down & sideways
    const duration = (speedMultiplier()*800) + 300; 
    const start = performance.now();
    const fromX = parseFloat(anim.style.left);
    const fromY = parseFloat(anim.style.top);
    const toX = targetX;
    const toY = destY;

    function frame(now){
      const t = Math.min(1, (now - start) / duration);
      // smooth step easing function
      const eased = t<0.5? 2*t*t : -1 + (4-2*t)*t; 
      anim.style.left = (fromX + (toX - fromX) * eased) + 'px';
      anim.style.top = (fromY + (toY - fromY) * eased) + 'px';
      if(t < 1){
        requestAnimationFrame(frame);
      } else {
        // placement logic
        const block = document.createElement('div'); block.className='block jp';
        block.innerHTML = `<div style="font-size:20px">${word.j}</div><div style="font-size:15px;color:var(--muted);margin-top:4px">${word.r}</div>`;
        
        columns[colIndex].push({word, node:block});
        pileGrid.children[colIndex].appendChild(block);
        
        if(anim.parentNode) anim.parentNode.removeChild(anim);
        removeFloating();
        
        // update lives
        lives = Math.max(0, maxRows - Math.max(...columns.map(c=>c.length)));
        updateHUD();
        flashFail();
        
        // check game over
        if(columns.some(c=>c.length >= maxRows)){
          endGame();
        }
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

/* utilities */
function speedMultiplier(){
  const v = $('#speedSelect').value;
  if(v==='slow') return 1.35;
  if(v==='normal') return 1.0;
  if(v==='fast') return 0.72;
  return 0.55; // veryfast
}

function getTimeLimit(){
  // Time limit is shorter (faster) on faster speed settings
  return Math.round(TIME_PER_WORD * speedMultiplier());
}

/* UI updates */
function updateHUD(){
  $('#score').textContent = score;
  $('#lives').textContent = Math.max(0, maxRows - Math.max(...columns.map(c=>c.length)));
  $('#streak').textContent = streak;

  // TIMER DISPLAY LOGIC
  const timerEl = $('#timerDisplay');
  timerEl.textContent = `${timeLeft}s`;
  timerEl.classList.toggle('low', timeLeft <= 3);
}

// TIMER LOGIC
function startCountdown(){
  if(countdownInterval) clearInterval(countdownInterval);
  timeLeft = getTimeLimit(); // Set time based on speed setting
  updateHUD();

  countdownInterval = setInterval(()=>{
    if(!running || paused) {
      clearInterval(countdownInterval);
      return;
    }
    timeLeft--;
    updateHUD();

    if(timeLeft <= 0){
      clearInterval(countdownInterval);
      if(currentWord) {
        // Handle Timeout as a wrong answer
        $('#answerArea').querySelectorAll('.choice-btn').forEach(b=>b.disabled=true);
        streak = 0; updateHUD();
        animatePlaceIntoPile(currentWord).then(()=> {
          currentWord = null;
          setTimeout(()=>{ if(running) spawnNext(); }, 420);
        });
      } else {
        // If somehow word is null, just spawn the next one.
        spawnNext();
      }
    }
  }, 1000);
}


/* game start / pause / reset */
function startGame(){
  if(running) return;

  if(countdownInterval) clearInterval(countdownInterval); // Ensure previous timer is cleared
  initColumns();
  running = true; paused=false; score=0; streak=0;
  vocabQueue = shuffle([...vocab]);
  currentWord = null; nextWord = pickNext();
  updateHUD();
  spawnNext();
}

function pauseGame(){
  paused = !paused;
  $('#pauseBtn').textContent = paused ? 'Resume' : 'Pause';
  running = !paused;

  // Pause or Resume the interval
  if(paused){
    if(countdownInterval) clearInterval(countdownInterval);
  } else {
    // Resume immediately by restarting the countdown (at the current timeLeft)
    startCountdown(); 
  }
}

function resetAll(){
  running=false; paused=false; $('#pauseBtn').textContent='Pause';
  if(countdownInterval) clearInterval(countdownInterval); // Clear interval on reset
  // clear pile
  initColumns();
  ['#floating'].forEach(id=>{ const el = $(id); if(el && el.parentNode) el.parentNode.removeChild(el); });
  $('#answerArea').innerHTML = '';
  $('#pvContent').textContent = '';
  $('#preview').textContent = '';
  score=0; streak=0;
  updateHUD();
}

/* end game */
function endGame(){
  running=false;
  if(countdownInterval) clearInterval(countdownInterval); // Stop timer when game is over
  // overlay
  const overlay = document.createElement('div'); overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.background='linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.45))';
  overlay.innerHTML = `<div style="background:#fff;padding:18px;border-radius:10px;border:1px solid rgba(3,59,73,0.06);text-align:center;color:#04202a"><h2 style="margin:0 0 8px 0">Game Over</h2><div style="margin-bottom:8px">Score: ${score}</div><button id="restartBtn" class="btn">Restart</button></div>`;
  document.querySelector('#game .card').appendChild(overlay);
  $('#restartBtn').addEventListener('click', ()=>{ overlay.remove(); resetAll(); startGame(); });
}

/* visual fail flash */
function flashFail(){
  const f = document.createElement('div'); f.className='flash-fail'; gameArea.appendChild(f);
  setTimeout(()=>{ if(f.parentNode) f.parentNode.removeChild(f); }, 420);
}

// **NEW VISUAL SUCCESS FLASH**
function flashSuccess(){
  const f = document.createElement('div'); f.className='flash-success'; gameArea.appendChild(f);
  setTimeout(()=>{ if(f.parentNode) f.parentNode.removeChild(f); }, 420);
}
// **END NEW VISUAL SUCCESS FLASH**


/* speech */
function speak(text){
  if(!text) return;
  if('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    const jp = voices.find(v=>/ja|japanese/i.test(v.lang||v.name));
    if(jp) u.voice = jp;
    u.lang = 'ja-JP';
    u.rate = 0.60;
    u.volume = 1.0;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }
}

/* end-of-life wiring */
$('#startBtn').addEventListener('click', ()=>{ resetAll(); startGame(); });
$('#pauseBtn').addEventListener('click', ()=>{ pauseGame(); });
$('#resetBtn').addEventListener('click', ()=>{ resetAll(); });

$('#speedSelect').addEventListener('change', ()=>{ 
  // If the game is running, immediately adjust the timer logic to the new speed
  if(running && !paused && currentWord){
    // Reset timer to the new time limit based on speed
    startCountdown(); 
  }
});

window.addEventListener('resize', ()=>{ initColumns(); if(currentWord) renderOptionsFor(currentWord); });

/* initial HUD */
updateHUD();

</script>
</body>
</html>